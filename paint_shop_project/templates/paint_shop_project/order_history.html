{% extends 'paint_shop_project/base.html' %}
{% load static %}
{% load math_filters %}

{% block title %}–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤ - –ñ–µ–≤–∂–∏–∫{% endblock %}

{% block extra_css %}
<style>
    .text-zhevzhik-pink { color: #FF6B9D !important; }
    .bg-zhevzhik-pink { background-color: #FF6B9D !important; }
    .btn-zhevzhik-pink { 
        background-color: #FF6B9D; 
        border-color: #FF6B9D; 
        color: white; 
    }
    .btn-zhevzhik-pink:hover { 
        background-color: #E91E63; 
        border-color: #E91E63; 
    }
    .mini-progress{width:120px;height:6px;background:#e9ecef;border-radius:4px;overflow:hidden;display:inline-block;vertical-align:middle;margin-left:8px}
    .mini-progress-fill{height:100%;background:linear-gradient(90deg,#FF6B9D,#4CAF50)}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">üê∑ –ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</h2>
        </div>
    </div>
    
    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="row mb-4 g-3">
        <div class="col-lg-3 col-md-6">
            <div class="card text-center h-100">
                <div class="card-body">
                    <h3 class="text-zhevzhik-pink">{{ total_orders }}</h3>
                    <p class="text-muted mb-0">–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="card text-center h-100">
                <div class="card-body">
                    <h3 class="text-zhevzhik-pink">{{ delivered_orders_count }}</h3>
                    <p class="text-muted mb-0">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="card text-center h-100">
                <div class="card-body">
                    <h3 class="text-zhevzhik-pink">{{ total_spent|floatformat:0 }} ‚ÇΩ</h3>
                    <p class="text-muted mb-0">–ü–æ—Ç—Ä–∞—á–µ–Ω–æ –ø–æ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–º</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="card text-center h-100">
                <div class="card-body">
                    <h3 class="text-zhevzhik-pink">
                        {% if delivered_orders_count > 0 %}
                            {{ average_spent|floatformat:0 }} ‚ÇΩ
                        {% else %}
                            0 ‚ÇΩ
                        {% endif %}
                    </h3>
                    <p class="text-muted mb-0">–°—Ä–µ–¥–Ω–∏–π —á–µ–∫ (–∑–∞–≤–µ—Ä—à—ë–Ω)</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-zhevzhik-pink text-white">
                    <h5 class="mb-0">–ú–æ–∏ –∑–∞–∫–∞–∑—ã</h5>
                </div>
                <div class="card-body">
                    <!-- –§–∏–ª—å—Ç—Ä—ã -->
                    <form method="get" class="row g-2 mb-3">
                        <div class="col-md-2">
                            <input type="text" name="q" value="{{ search }}" class="form-control" placeholder="–ü–æ–∏—Å–∫ –ø–æ ‚Ññ">
                        </div>
                        <div class="col-md-2">
                            <select name="status" class="form-select">
                                <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                                <option value="created" {% if selected_status == 'created' %}selected{% endif %}>–°–æ–∑–¥–∞–Ω</option>
                                <option value="confirmed" {% if selected_status == 'confirmed' %}selected{% endif %}>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω</option>
                                <option value="ready" {% if selected_status == 'ready' %}selected{% endif %}>–ì–æ—Ç–æ–≤</option>
                                <option value="in_transit" {% if selected_status == 'in_transit' %}selected{% endif %}>–í –ø—É—Ç–∏</option>
                                <option value="delivered" {% if selected_status == 'delivered' %}selected{% endif %}>–î–æ—Å—Ç–∞–≤–ª–µ–Ω</option>
                                <option value="cancelled" {% if selected_status == 'cancelled' %}selected{% endif %}>–û—Ç–º–µ–Ω—ë–Ω</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select name="delivery_type" class="form-select">
                                <option value="">–í—Å–µ —Å–ø–æ—Å–æ–±—ã</option>
                                <option value="pickup" {% if selected_delivery_type == 'pickup' %}selected{% endif %}>–°–∞–º–æ–≤—ã–≤–æ–∑</option>
                                <option value="delivery" {% if selected_delivery_type == 'delivery' %}selected{% endif %}>–î–æ—Å—Ç–∞–≤–∫–∞</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <input type="date" name="date_from" value="{{ date_from }}" class="form-control" placeholder="–° –¥–∞—Ç—ã">
                        </div>
                        <div class="col-md-2">
                            <input type="date" name="date_to" value="{{ date_to }}" class="form-control" placeholder="–ü–æ –¥–∞—Ç—É">
                        </div>
                        <div class="col-md-1">
                            <input type="number" name="min_total" value="{{ min_total }}" class="form-control" placeholder=">= ‚ÇΩ">
                        </div>
                        <div class="col-md-1">
                            <input type="number" name="max_total" value="{{ max_total }}" class="form-control" placeholder="<= ‚ÇΩ">
                        </div>
                        <div class="col-md-12 d-flex gap-2 mt-2">
                            <button type="submit" class="btn btn-sm btn-zhevzhik-pink">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                            <a href="{% url 'order_history' %}" class="btn btn-sm btn-outline-secondary">–°–±—Ä–æ—Å–∏—Ç—å</a>
                        </div>
                    </form>

                    {% if orders %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>‚Ññ –ó–∞–∫–∞–∑–∞</th>
                                        <th>–î–∞—Ç–∞</th>
                                        <th>–°—Ç–∞—Ç—É—Å</th>
                                        <th>–°—É–º–º–∞</th>
                                        <th>–°–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è</th>
                                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for order in orders %}
                                    <tr>
                                        <td>
                                            <a href="{% url 'order_detail' order.id %}" class="text-decoration-none">
                                                #{{ order.id }}
                                            </a>
                                        </td>
                                        <td>{{ order.order_date|date:"d.m.Y H:i" }}</td>
                                        <td>
                                            <span class="badge 
                                                {% if order.status == 'created' %}bg-secondary
                                                {% elif order.status == 'confirmed' %}bg-primary
                                                {% elif order.status == 'ready' %}bg-warning
                                                {% elif order.status == 'in_transit' %}bg-info
                                                {% elif order.status == 'delivered' %}bg-success
                                                {% elif order.status == 'cancelled' %}bg-danger
                                                {% endif %}">
                                                {{ order.get_status_display }}
                                            </span>
                                            <span class="mini-progress"><span class="mini-progress-fill" style="width: {{ order.progress|default:0 }}%"></span></span>
                                        </td>
                                        <td>{{ order.total_amount }} ‚ÇΩ</td>
                                        <td>{{ order.get_delivery_type_display }}</td>
                                        <td>
                                            <a href="{% url 'order_detail' order.id %}" class="btn btn-sm btn-outline-zhevzhik-pink">
                                                <i class="fas fa-eye"></i> –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                                            </a>
                                            {% if order.delivery_type == 'delivery' and order.status != 'cancelled' %}
                                                <a href="{% url 'order_tracking' order.id %}" class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-truck"></i> –û—Ç—Å–ª–µ–¥–∏—Ç—å
                                                </a>
                                            {% endif %}
                                            {% if order.status == 'created' or order.status == 'confirmed' %}
                                                <button class="btn btn-sm btn-outline-danger" onclick="cancelOrder({{ order.id }})">
                                                    <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∏—Ç—å
                                                </button>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
                        <nav aria-label="Orders pagination">
                            <ul class="pagination justify-content-center">
                                {% if orders.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ orders.previous_page_number }}{% if request.GET %}&{{ request.GET.urlencode|cut:'page='|cut:orders.number|cut:'&' %}{% endif %}">–ù–∞–∑–∞–¥</a>
                                </li>
                                {% else %}
                                <li class="page-item disabled"><span class="page-link">–ù–∞–∑–∞–¥</span></li>
                                {% endif %}
                                <li class="page-item disabled"><span class="page-link">–°—Ç—Ä. {{ orders.number }} –∏–∑ {{ orders.paginator.num_pages }}</span></li>
                                {% if orders.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ orders.next_page_number }}{% if request.GET %}&{{ request.GET.urlencode|cut:'page='|cut:orders.number|cut:'&' %}{% endif %}">–í–ø–µ—Ä—ë–¥</a>
                                </li>
                                {% else %}
                                <li class="page-item disabled"><span class="page-link">–í–ø–µ—Ä—ë–¥</span></li>
                                {% endif %}
                            </ul>
                        </nav>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-shopping-bag fa-3x text-muted mb-3"></i>
                            <h4>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤</h4>
                            <p class="text-muted">–°–¥–µ–ª–∞–π—Ç–µ —Å–≤–æ–π –ø–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑ –≤ –Ω–∞—à–µ–º –º–∞–≥–∞–∑–∏–Ω–µ!</p>
                            <a href="{% url 'product_list' %}" class="btn btn-zhevzhik-pink">
                                <i class="fas fa-shopping-bag"></i> –ü–µ—Ä–µ–π—Ç–∏ –∫ –ø–æ–∫—É–ø–∫–∞–º
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function cancelOrder(orderId) {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å —ç—Ç–æ—Ç –∑–∞–∫–∞–∑?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/cancel-order/${orderId}/`;
        
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrfToken;
        form.appendChild(csrfInput);
        
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}
