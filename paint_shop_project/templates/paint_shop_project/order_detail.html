{% extends 'paint_shop_project/base.html' %}
{% load static %}

{% block title %}–ó–∞–∫–∞–∑ #{{ order.id }} - –ñ–µ–≤–∂–∏–∫{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'home' %}">–ì–ª–∞–≤–Ω–∞—è</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'order_history' %}">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</a></li>
                    <li class="breadcrumb-item active">–ó–∞–∫–∞–∑ #{{ order.id }}</li>
                </ol>
            </nav>
        </div>
    </div>
    
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">üê∑ –ó–∞–∫–∞–∑ #{{ order.id }}</h2>
        </div>
    </div>
    
    <div class="row">
        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ -->
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header bg-zhevzhik-pink text-white">
                    <h5 class="mb-0">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>–î–∞—Ç–∞ –∑–∞–∫–∞–∑–∞:</strong> {{ order.order_date|date:"d.m.Y H:i" }}</p>
                            <p><strong>–°—Ç–∞—Ç—É—Å:</strong> 
                                <span class="badge 
                                    {% if order.status == 'created' %}bg-secondary
                                    {% elif order.status == 'confirmed' %}bg-primary
                                    {% elif order.status == 'ready' %}bg-warning
                                    {% elif order.status == 'in_transit' %}bg-info
                                    {% elif order.status == 'delivered' %}bg-success
                                    {% elif order.status == 'cancelled' %}bg-danger
                                    {% endif %}">
                                    {{ order.get_status_display }}
                                </span>
                            </p>
                            <p><strong>–°–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è:</strong> {{ order.get_delivery_type_display }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã:</strong> {{ order.get_payment_method_display }}</p>
                            {% if order.delivery_address %}
                                <p><strong>–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏:</strong> {{ order.delivery_address }}</p>
                            {% endif %}
                            {% if order.pickup_point %}
                                <p><strong>–¢–æ—á–∫–∞ —Å–∞–º–æ–≤—ã–≤–æ–∑–∞:</strong> {{ order.pickup_point.name }}</p>
                            {% endif %}
                        </div>
                    </div>
                    
                    {% if order.comment %}
                    <div class="mt-3">
                        <strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–∫–∞–∑—É:</strong>
                        <p class="text-muted">{{ order.comment }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç–∞—Ç—É—Å—ã -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h6 class="mb-0">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞</h6>
                </div>
                <div class="card-body">
                    {% if recent_statuses %}
                        <ul class="list-unstyled mb-0">
                            {% for s in recent_statuses %}
                            <li class="mb-2">
                                <small class="text-muted">{{ s.timestamp|date:"d.m.Y H:i" }}</small><br>
                                <strong>{{ s.get_status_display }}</strong>
                                {% if s.comment %}<span class="text-muted">‚Äî {{ s.comment }}</span>{% endif %}
                            </li>
                            {% endfor %}
                        </ul>
                        {% if order.delivery_type == 'delivery' %}
                        <a class="btn btn-outline-primary btn-sm mt-2" href="{% url 'order_tracking' order.id %}">
                            <i class="fas fa-truck me-1"></i>–ü–æ–ª–Ω—ã–π —Ç—Ä–µ–∫–∏–Ω–≥
                        </a>
                        {% endif %}
                    {% else %}
                        <p class="text-muted mb-0">–ù–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —Å—Ç–∞—Ç—É—Å–∞</p>
                    {% endif %}
                </div>
            </div>

            <!-- –¢–æ–≤–∞—Ä—ã –≤ –∑–∞–∫–∞–∑–µ -->
            <div class="card">
                <div class="card-header bg-zhevzhik-yellow text-dark">
                    <h5 class="mb-0">–¢–æ–≤–∞—Ä—ã –≤ –∑–∞–∫–∞–∑–µ</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>–¢–æ–≤–∞—Ä</th>
                                    <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                                    <th>–¶–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É</th>
                                    <th>–°—É–º–º–∞</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in order.items.all %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            {% if item.product.image %}
                                                <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" class="me-3" style="width: 50px; height: 50px; object-fit: cover;">
                                            {% endif %}
                                            <div>
                                                <h6 class="mb-0">{{ item.product.name }}</h6>
                                                <small class="text-muted">{{ item.product.unit }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>{{ item.quantity }}</td>
                                    <td>{{ item.price_per_unit }} ‚ÇΩ</td>
                                    <td><strong>{{ item.total_price }} ‚ÇΩ</strong></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <th colspan="3" class="text-end">–¢–æ–≤–∞—Ä—ã:</th>
                                    <th>
                                        {{ order.total_amount|add:order.delivery_cost|add:order.favorite_discount_amount|add:order.promotion_discount|floatformat:0 }} ‚ÇΩ
                                    </th>
                                </tr>
                                {% if order.favorite_discount_amount and order.favorite_discount_amount > 0 %}
                                <tr>
                                    <th colspan="3" class="text-end">–°–∫–∏–¥–∫–∞ –ª—é–±–∏–º—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π:</th>
                                    <th class="text-success">-{{ order.favorite_discount_amount|floatformat:0 }} ‚ÇΩ</th>
                                </tr>
                                {% endif %}
                                {% if order.promotion_discount and order.promotion_discount > 0 %}
                                <tr>
                                    <th colspan="3" class="text-end">–°–∫–∏–¥–∫–∞ –ø–æ –∞–∫—Ü–∏–∏:</th>
                                    <th class="text-success">-{{ order.promotion_discount|floatformat:0 }} ‚ÇΩ</th>
                                </tr>
                                {% endif %}
                                <tr>
                                    <th colspan="3" class="text-end">–î–æ—Å—Ç–∞–≤–∫–∞:</th>
                                    <th>{{ order.delivery_cost|floatformat:0 }} ‚ÇΩ</th>
                                </tr>
                                <tr class="table-active">
                                    <th colspan="3">–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</th>
                                    <th>{{ order.total_amount|floatformat:0 }} ‚ÇΩ</th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –î–µ–π—Å—Ç–≤–∏—è -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header bg-light">
                    <h6 class="mb-0">–î–µ–π—Å—Ç–≤–∏—è</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'order_history' %}" class="btn btn-outline-zhevzhik-pink">
                            <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ –∑–∞–∫–∞–∑–∞–º
                        </a>
                        
                        {% if order.status == 'created' %}
                            <button class="btn btn-zhevzhik-pink" onclick="processPayment({{ order.id }})">
                                <i class="fas fa-credit-card"></i> –û–ø–ª–∞—Ç–∏—Ç—å –∑–∞–∫–∞–∑
                            </button>
                        {% endif %}
                        
                        {% if order.status in 'created,confirmed' %}
                            <button class="btn btn-outline-danger" onclick="cancelOrder({{ order.id }})">
                                <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑
                            </button>
                        {% endif %}
                        
                        <a href="{% url 'product_list' %}" class="btn btn-zhevzhik-pink">
                            <i class="fas fa-shopping-bag"></i> –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–∫—É–ø–∫–∏
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- –ö–æ–Ω—Ç–∞–∫—Ç—ã -->
            <div class="card mt-3">
                <div class="card-body">
                    <h6 class="text-zhevzhik-pink">–ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å?</h6>
                    <p class="mb-2">üìû +7 (495) 123-45-67</p>
                    <p class="mb-0">‚úâÔ∏è info@zhevzhik.ru</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function cancelOrder(orderId) {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å —ç—Ç–æ—Ç –∑–∞–∫–∞–∑?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/cancel-order/${orderId}/`;
        
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrfToken;
        form.appendChild(csrfInput);
        
        document.body.appendChild(form);
        form.submit();
    }
}

function processPayment(orderId) {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –≤—ã–±–æ—Ä–æ–º —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="payment-form">
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="radio" name="payment_method" id="card" value="card" checked>
                            <label class="form-check-label" for="card">
                                <i class="fas fa-credit-card me-2"></i>–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞
                            </label>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="radio" name="payment_method" id="online" value="online">
                            <label class="form-check-label" for="online">
                                <i class="fas fa-mobile-alt me-2"></i>–û–Ω–ª–∞–π–Ω-–ø–ª–∞—Ç–µ–∂
                            </label>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="radio" name="payment_method" id="cash" value="cash">
                            <label class="form-check-label" for="cash">
                                <i class="fas fa-money-bill me-2"></i>–ù–∞–ª–∏—á–Ω—ã–µ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="button" class="btn btn-zhevzhik-pink" onclick="submitPayment(${orderId})">
                        <i class="fas fa-credit-card"></i> –û–ø–ª–∞—Ç–∏—Ç—å
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
    
    // –£–¥–∞–ª—è–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è
    modal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal);
    });
}

function submitPayment(orderId) {
    const form = document.getElementById('payment-form');
    const formData = new FormData(form);
    
    // –°–æ–∑–¥–∞–µ–º —Ñ–æ—Ä–º—É –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
    const submitForm = document.createElement('form');
    submitForm.method = 'POST';
    submitForm.action = `/process-payment/${orderId}/`;
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = csrfToken;
    submitForm.appendChild(csrfInput);
    
    const paymentMethodInput = document.createElement('input');
    paymentMethodInput.type = 'hidden';
    paymentMethodInput.name = 'payment_method';
    paymentMethodInput.value = formData.get('payment_method');
    submitForm.appendChild(paymentMethodInput);
    
    document.body.appendChild(submitForm);
    submitForm.submit();
}
</script>
{% endblock %}
