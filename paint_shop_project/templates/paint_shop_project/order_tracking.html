{% extends 'paint_shop_project/base.html' %}
{% load static %}

{% block title %}Отслеживание заказа #{{ order.id }} - Жевжик{% endblock %}

{% block extra_css %}
<style>
    :root {
        --zhevzhik-pink: #FF6B9D;
        --zhevzhik-dark-pink: #E91E63;
        --zhevzhik-light-pink: #FFB3D1;
        --zhevzhik-green: #4CAF50;
        --zhevzhik-yellow: #FFEB3B;
        --zhevzhik-gray: #6c757d;
        --zhevzhik-dark-gray: #2c3e50;
    }
    
    .tracking-hero {
        background: linear-gradient(135deg, var(--zhevzhik-pink), var(--zhevzhik-dark-pink));
        color: white;
        padding: 40px 0;
        margin-bottom: 30px;
    }
    
    .tracking-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        padding: 30px;
        margin-bottom: 30px;
    }
    
    .progress-container {
        position: relative;
        margin: 30px 0;
    }
    
    .progress-bar {
        height: 8px;
        background: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
    }
    
    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--zhevzhik-pink), var(--zhevzhik-green));
        border-radius: 4px;
        transition: width 0.3s ease;
    }
    
    .status-steps {
        display: flex;
        justify-content: space-between;
        margin-top: 20px;
    }
    
    .status-step {
        text-align: center;
        flex: 1;
        position: relative;
    }
    
    .status-step::after {
        content: '';
        position: absolute;
        top: 15px;
        right: -50%;
        width: 100%;
        height: 2px;
        background: #e9ecef;
        z-index: 1;
    }
    
    .status-step:last-child::after {
        display: none;
    }
    
    .status-step.active::after {
        background: var(--zhevzhik-pink);
    }
    
    .step-icon {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: #e9ecef;
        color: #6c757d;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 10px;
        position: relative;
        z-index: 2;
        font-size: 14px;
    }
    
    .status-step.active .step-icon {
        background: var(--zhevzhik-pink);
        color: white;
    }
    
    .status-step.completed .step-icon {
        background: var(--zhevzhik-green);
        color: white;
    }
    
    .step-label {
        font-size: 12px;
        color: #6c757d;
        font-weight: 500;
    }
    
    .status-step.active .step-label {
        color: var(--zhevzhik-pink);
        font-weight: 600;
    }
    
    .status-step.completed .step-label {
        color: var(--zhevzhik-green);
        font-weight: 600;
    }
    
    .timeline {
        position: relative;
        padding-left: 30px;
    }
    
    .timeline::before {
        content: '';
        position: absolute;
        left: 15px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: #e9ecef;
    }
    
    .timeline-item {
        position: relative;
        margin-bottom: 30px;
        padding-left: 20px;
    }
    
    .timeline-item::before {
        content: '';
        position: absolute;
        left: -23px;
        top: 5px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: var(--zhevzhik-pink);
        border: 3px solid white;
        box-shadow: 0 0 0 2px var(--zhevzhik-pink);
    }
    
    .timeline-content {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        border-left: 4px solid var(--zhevzhik-pink);
    }
    
    .timeline-time {
        font-size: 12px;
        color: var(--zhevzhik-gray);
        margin-bottom: 5px;
    }
    
    .timeline-status {
        font-weight: 600;
        color: var(--zhevzhik-pink);
        margin-bottom: 5px;
    }
    
    .timeline-comment {
        color: var(--zhevzhik-dark-gray);
        font-size: 14px;
    }
    
    .courier-info {
        background: linear-gradient(135deg, var(--zhevzhik-light-pink), white);
        border-radius: 10px;
        padding: 20px;
        margin-top: 20px;
    }
    
    .courier-avatar {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: var(--zhevzhik-pink);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        margin-right: 15px;
    }
    
    .order-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .info-card {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        border-left: 4px solid var(--zhevzhik-pink);
    }
    
    .info-label {
        font-size: 12px;
        color: var(--zhevzhik-gray);
        text-transform: uppercase;
        font-weight: 600;
        margin-bottom: 5px;
    }
    
    .info-value {
        font-size: 16px;
        color: var(--zhevzhik-dark-gray);
        font-weight: 500;
    }
    
    .estimated-time {
        background: linear-gradient(135deg, var(--zhevzhik-yellow), #fff3cd);
        color: #856404;
        padding: 15px;
        border-radius: 10px;
        text-align: center;
        margin-top: 20px;
    }
    
    .estimated-time i {
        font-size: 24px;
        margin-bottom: 10px;
    }
    
    @media (max-width: 768px) {
        .status-steps {
            flex-direction: column;
            gap: 20px;
        }
        
        .status-step::after {
            display: none;
        }
        
        .order-info-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Герой секция -->
<div class="tracking-hero">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="display-5 fw-bold mb-3">
                    <i class="fas fa-truck me-3"></i>Отслеживание заказа
                </h1>
                <p class="lead mb-0">Заказ #{{ order.id }} • {{ order.get_status_display }}</p>
            </div>
            <div class="col-md-4 text-end">
                <div class="tracking-number">
                    <small class="text-white-50">Номер отслеживания</small>
                    <div class="h4 mb-0">{{ order.tracking_number|default:"#"|add:order.id }}</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <!-- Прогресс заказа -->
    <div class="tracking-card">
        <h3 class="mb-4">
            <i class="fas fa-route me-2"></i>Прогресс заказа
        </h3>
        
        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" style="width: {{ progress }}%"></div>
            </div>
            
            <div class="status-steps">
                <div class="status-step {% if order.status == 'created' %}active{% elif order.status in 'confirmed,ready,in_transit,delivered' %}completed{% endif %}">
                    <div class="step-icon">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    <div class="step-label">Создан</div>
                </div>
                
                <div class="status-step {% if order.status == 'confirmed' %}active{% elif order.status in 'ready,in_transit,delivered' %}completed{% endif %}">
                    <div class="step-icon">
                        <i class="fas fa-check"></i>
                    </div>
                    <div class="step-label">Подтверждён</div>
                </div>
                
                <div class="status-step {% if order.status == 'ready' %}active{% elif order.status in 'in_transit,delivered' %}completed{% endif %}">
                    <div class="step-icon">
                        <i class="fas fa-box"></i>
                    </div>
                    <div class="step-label">Готов</div>
                </div>
                
                {% if order.delivery_type == 'delivery' %}
                <div class="status-step {% if order.status == 'in_transit' %}active{% elif order.status == 'delivered' %}completed{% endif %}">
                    <div class="step-icon">
                        <i class="fas fa-truck"></i>
                    </div>
                    <div class="step-label">В пути</div>
                </div>
                {% endif %}
                
                <div class="status-step {% if order.status == 'delivered' %}active{% endif %}">
                    <div class="step-icon">
                        <i class="fas fa-home"></i>
                    </div>
                    <div class="step-label">{% if order.delivery_type == 'delivery' %}Доставлен{% else %}Получен{% endif %}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Информация о заказе -->
    <div class="order-info-grid">
        <div class="info-card">
            <div class="info-label">Дата заказа</div>
            <div class="info-value">{{ order.order_date|date:"d.m.Y H:i" }}</div>
        </div>
        
        <div class="info-card">
            <div class="info-label">Способ получения</div>
            <div class="info-value">{{ order.get_delivery_type_display }}</div>
        </div>
        
        <div class="info-card">
            <div class="info-label">Способ оплаты</div>
            <div class="info-value">{{ order.get_payment_method_display }}</div>
        </div>
        
        <div class="info-card">
            <div class="info-label">Сумма заказа</div>
            <div class="info-value">{{ order.total_amount }} ₽</div>
        </div>
    </div>

    {% if order.delivery_type == 'delivery' %}
    <!-- Информация о доставке -->
    <div class="tracking-card">
        <h3 class="mb-4">
            <i class="fas fa-map-marker-alt me-2"></i>Информация о доставке
        </h3>
        
        <div class="row">
            <div class="col-md-8">
                <div class="info-card">
                    <div class="info-label">Адрес доставки</div>
                    <div class="info-value">{{ order.delivery_address }}</div>
                </div>
            </div>
            <div class="col-md-4">
                {% if order.estimated_delivery_time %}
                <div class="estimated-time">
                    <i class="fas fa-clock"></i>
                    <div class="fw-bold">Ожидаемое время доставки</div>
                    <div>{{ order.estimated_delivery_time|date:"d.m.Y H:i" }}</div>
                </div>
                {% endif %}
            </div>
        </div>
        
        {% if order.courier_name %}
        <div class="courier-info">
            <div class="d-flex align-items-center">
                <div class="courier-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div>
                    <h5 class="mb-1">{{ order.courier_name }}</h5>
                    <p class="mb-0 text-muted">Курьер</p>
                    {% if order.courier_phone %}
                    <small class="text-muted">
                        <i class="fas fa-phone me-1"></i>{{ order.courier_phone }}
                    </small>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- История статусов -->
    <div class="tracking-card">
        <h3 class="mb-4">
            <i class="fas fa-history me-2"></i>История заказа
        </h3>
        
        {% if status_history %}
        <div class="timeline">
            {% for history in status_history %}
            <div class="timeline-item">
                <div class="timeline-content">
                    <div class="timeline-time">{{ history.timestamp|date:"d.m.Y H:i" }}</div>
                    <div class="timeline-status">{{ history.get_status_display }}</div>
                    {% if history.comment %}
                    <div class="timeline-comment">{{ history.comment }}</div>
                    {% endif %}
                    {% if history.courier_name %}
                    <div class="timeline-comment mt-2">
                        <i class="fas fa-user me-1"></i>Курьер: {{ history.courier_name }}
                        {% if history.courier_phone %}
                        • <i class="fas fa-phone me-1"></i>{{ history.courier_phone }}
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-4">
            <i class="fas fa-history fa-3x text-muted mb-3"></i>
            <p class="text-muted">История заказа пока пуста</p>
        </div>
        {% endif %}
    </div>

    <!-- Действия -->
    <div class="tracking-card">
        <div class="row">
            <div class="col-md-6">
                <a href="{% url 'order_history' %}" class="btn btn-outline-primary">
                    <i class="fas fa-arrow-left me-2"></i>К истории заказов
                </a>
            </div>
            <div class="col-md-6 text-end">
                {% if order.status == 'delivered' %}
                <a href="{% url 'rate_employee' order.id %}" class="btn btn-primary">
                    <i class="fas fa-star me-2"></i>Оценить заказ
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
