{% extends 'paint_shop_project/base.html' %}
{% load static %}

{% block title %}–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ - –ñ–µ–≤–∂–∏–∫{% endblock %}

{% block extra_css %}
<style>
    :root {
        --zhevzhik-pink: #FF6B9D;
        --zhevzhik-dark-pink: #E91E63;
        --zhevzhik-light-pink: #FFB3D1;
        --zhevzhik-green: #4CAF50;
        --zhevzhik-yellow: #FFEB3B;
        --zhevzhik-gray: #6c757d;
        --zhevzhik-dark-gray: #2c3e50;
    }
    
    .bg-zhevzhik-pink {
        background-color: var(--zhevzhik-pink) !important;
    }
    
    .text-zhevzhik-pink {
        color: var(--zhevzhik-pink) !important;
    }
    
    .btn-zhevzhik-pink {
        background-color: var(--zhevzhik-pink);
        border-color: var(--zhevzhik-pink);
        color: white;
    }
    
    .btn-zhevzhik-pink:hover {
        background-color: var(--zhevzhik-dark-pink);
        border-color: var(--zhevzhik-dark-pink);
        color: white;
    }
    
    .bg-zhevzhik-yellow {
        background-color: var(--zhevzhik-yellow) !important;
    }
    
    .card-header {
        font-weight: 600;
    }
    
    .form-check-label {
        color: var(--zhevzhik-dark-gray);
    }
    
    .form-label {
        color: var(--zhevzhik-dark-gray);
        font-weight: 600;
    }
    
    .card {
        border: none;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .card-header {
        border-bottom: 1px solid rgba(0,0,0,0.125);
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è YooMoney –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
    .payment-progress {
        margin-bottom: 30px;
    }
    
    .progress-steps {
        position: relative;
    }
    
    .progress-steps::before {
        content: '';
        position: absolute;
        top: 20px;
        left: 10%;
        right: 10%;
        height: 2px;
        background: #e9ecef;
        z-index: 1;
    }
    
    .step {
        text-align: center;
        position: relative;
        z-index: 2;
    }
    
    .step-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #e9ecef;
        color: #6c757d;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 10px;
        font-size: 16px;
        transition: all 0.3s ease;
    }
    
    .step.active .step-icon {
        background: #4f46e5;
        color: white;
    }
    
    .step.completed .step-icon {
        background: #10b981;
        color: white;
    }
    
    .step-label {
        font-size: 12px;
        color: #6c757d;
        font-weight: 500;
    }
    
    .step.active .step-label {
        color: #4f46e5;
        font-weight: 600;
    }
    
    .step.completed .step-label {
        color: #10b981;
        font-weight: 600;
    }
    
    .card-icons {
        font-size: 20px;
    }
    
    .payment-form .form-control:focus {
        border-color: #4f46e5;
        box-shadow: 0 0 0 0.2rem rgba(79, 70, 229, 0.25);
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ —Å–ø–æ—Å–æ–±–æ–≤ –æ–ø–ª–∞—Ç—ã */
    .payment-method-card {
        position: relative;
        border: 2px solid #e9ecef;
        border-radius: 12px;
        padding: 0;
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
        overflow: hidden;
    }
    
    .payment-method-card:hover {
        border-color: var(--zhevzhik-pink);
        box-shadow: 0 4px 12px rgba(255, 107, 157, 0.2);
        transform: translateY(-2px);
    }
    
    .payment-radio {
        position: absolute;
        opacity: 0;
        width: 0;
        height: 0;
    }
    
    .payment-label {
        display: block;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        margin: 0;
    }
    
    .payment-icon {
        margin-bottom: 12px;
        color: var(--zhevzhik-pink);
    }
    
    .payment-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--zhevzhik-dark-gray);
        margin-bottom: 6px;
    }
    
    .payment-subtitle {
        font-size: 14px;
        color: #6c757d;
        margin-bottom: 8px;
    }
    
    .payment-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
        background: #e9ecef;
        color: #6c757d;
        margin-top: 8px;
    }
    
    .payment-badge-success {
        background: #d4edda;
        color: #155724;
    }
    
    .payment-badge-default {
        background: var(--zhevzhik-light-pink);
        color: var(--zhevzhik-dark-pink);
    }
    
    .payment-radio:checked + .payment-label {
        background: linear-gradient(135deg, var(--zhevzhik-light-pink), white);
    }
    
    .payment-radio:checked ~ .payment-method-card,
    .payment-radio:checked + .payment-label .payment-method-card {
        border-color: var(--zhevzhik-pink);
        box-shadow: 0 4px 16px rgba(255, 107, 157, 0.3);
    }
    
    .payment-radio:checked + .payment-label .payment-icon {
        color: var(--zhevzhik-dark-pink);
        transform: scale(1.1);
    }
    
    .payment-radio:checked + .payment-label .payment-title {
        color: var(--zhevzhik-dark-pink);
    }
    
    .payment-method-card.selected {
        border-color: var(--zhevzhik-pink);
        box-shadow: 0 4px 16px rgba(255, 107, 157, 0.3);
        background: linear-gradient(135deg, var(--zhevzhik-light-pink), white);
    }
    
    .payment-method-card.selected .payment-icon {
        color: var(--zhevzhik-dark-pink);
        transform: scale(1.1);
    }
    
    .payment-method-card.selected .payment-title {
        color: var(--zhevzhik-dark-pink);
    }
    
    .saved-card {
        border-style: dashed;
    }
    
    .saved-card:hover {
        border-style: solid;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4" id="checkout-root"
     data-base-total="{{ total_without_delivery|default:0 }}"
     data-free-threshold="{{ free_delivery_threshold|default:5000 }}"
     data-cashback-balance="{{ cashback_balance|default:0 }}"
     data-default-address-id="{{ default_address.id|default:'' }}">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">üê∑ –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h2>
        </div>
    </div>
    
    <div class="row">
        <!-- –§–æ—Ä–º–∞ –∑–∞–∫–∞–∑–∞ -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-zhevzhik-pink text-white">
                    <h5 class="mb-0">–î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞</h5>
                </div>
                <div class="card-body">
                    <form method="post" action="{% url 'create_order' %}">
                        {% csrf_token %}
                        
                        <!-- –°–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è -->
                        <div class="mb-4">
                            <h6 class="text-zhevzhik-pink">–°–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è</h6>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="delivery_type" id="pickup" value="pickup" checked onchange="toggleDelivery()">
                                <label class="form-check-label" for="pickup">
                                    <strong>–°–∞–º–æ–≤—ã–≤–æ–∑</strong> - –±–µ—Å–ø–ª–∞—Ç–Ω–æ
                                    <br><small class="text-muted">–ú–æ—Å–∫–≤–∞, –õ—é–±—É—á–∞–Ω—Å–∫–∏–π –ø–µ—Ä–µ—É–ª–æ–∫, 1–∫3</small>
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="delivery_type" id="delivery" value="delivery" onchange="toggleDelivery()">
                                <label class="form-check-label" for="delivery">
                                    <strong>–î–æ—Å—Ç–∞–≤–∫–∞</strong> - <span id="delivery-price-text">200 ‚ÇΩ</span>
                                    <br><small class="text-muted">–î–æ—Å—Ç–∞–≤–∏–º –≤ —Ç–µ—á–µ–Ω–∏–µ 2-4 —á–∞—Å–æ–≤</small>
                                    <div id="delivery-address-preview" class="mt-2 p-2 bg-light rounded" style="display: none;">
                                        <small><strong>–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏:</strong></small>
                                        <div id="selected-address-full" class="text-muted small"></div>
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <!-- –ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏ -->
                        <div class="mb-4" id="delivery-address" style="display: none;">
                            <h6 class="text-zhevzhik-pink mb-3">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</h6>
                            {% if user_addresses %}
                            <div class="mb-3">
                                <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –∞–¥—Ä–µ—Å</label>
                                <select class="form-select" name="address_id" id="address_id">
                                    <option value="">–ù–æ–≤—ã–π –∞–¥—Ä–µ—Å</option>
                                    {% for a in user_addresses %}
                                        <option value="{{ a.id }}" 
                                                data-address="{{ a.address }}"
                                                data-entrance="{{ a.entrance|default:'' }}"
                                                data-apartment="{{ a.apartment|default:'' }}"
                                                data-floor="{{ a.floor|default:'' }}"
                                                data-intercom="{{ a.intercom_code|default:'' }}"
                                                data-comment="{{ a.comment|default:'' }}"
                                                {% if default_address and a.id == default_address.id %}selected{% endif %}>
                                            {{ a.label|default:'–ê–¥—Ä–µ—Å' }} ‚Äî {{ a.address }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            {% endif %}
                            <div class="row">
                                 <div class="col-md-8 mb-3">
                                     <label for="delivery_address" class="form-label">–ê–¥—Ä–µ—Å <span class="text-danger">*</span></label>
                                     <input type="text" class="form-control" id="delivery_address" name="delivery_address" 
                                           placeholder="–£–ª–∏—Ü–∞, –¥–æ–º, –∫–æ—Ä–ø—É—Å" value="{{ default_address.address|default:'' }}">
                                 </div>
                                <div class="col-md-4 mb-3">
                                    <label for="delivery_entrance" class="form-label">–ü–æ–¥—ä–µ–∑–¥</label>
                                    <input type="text" class="form-control" id="delivery_entrance" name="delivery_entrance" 
                                           placeholder="–ù–æ–º–µ—Ä –ø–æ–¥—ä–µ–∑–¥–∞" value="{{ default_address.entrance|default:'' }}">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="delivery_apartment" class="form-label">–ö–≤–∞—Ä—Ç–∏—Ä–∞</label>
                                    <input type="text" class="form-control" id="delivery_apartment" name="delivery_apartment" 
                                           placeholder="–ù–æ–º–µ—Ä –∫–≤–∞—Ä—Ç–∏—Ä—ã" value="{{ default_address.apartment|default:'' }}">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="delivery_floor" class="form-label">–≠—Ç–∞–∂</label>
                                    <input type="text" class="form-control" id="delivery_floor" name="delivery_floor" 
                                           placeholder="–ù–æ–º–µ—Ä —ç—Ç–∞–∂–∞" value="{{ default_address.floor|default:'' }}">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3 d-flex align-items-end">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="save_address" name="save_address">
                                        <label class="form-check-label" for="save_address">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∞–¥—Ä–µ—Å</label>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="delivery_comment" class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –¥–æ—Å—Ç–∞–≤–∫–µ</label>
                                <textarea class="form-control" id="delivery_comment" name="delivery_comment" rows="2" 
                                          placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –∫—É—Ä—å–µ—Ä–∞">{{ default_address.comment|default:'' }}</textarea>
                            </div>
                        </div>
                        
                        <!-- –°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã -->
                        <div class="mb-4">
                            <h6 class="text-zhevzhik-pink mb-3">
                                <i class="fas fa-credit-card me-2"></i>–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã
                            </h6>
                            
                            <!-- –í–∏–∑—É–∞–ª—å–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å–ø–æ—Å–æ–±–æ–≤ –æ–ø–ª–∞—Ç—ã -->
                            <div class="row g-3 payment-methods-grid">
                                <!-- –ù–∞–ª–∏—á–Ω—ã–º–∏ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ -->
                                <div class="col-md-6 col-lg-4">
                                    <div class="payment-method-card" data-payment="cash">
                                        <input type="radio" name="payment_method" id="cash" value="cash" checked onchange="togglePayment()" class="payment-radio">
                                        <label for="cash" class="payment-label">
                                            <div class="payment-icon">
                                                <i class="fas fa-money-bill-wave fa-2x"></i>
                                            </div>
                                            <div class="payment-title">–ù–∞–ª–∏—á–Ω—ã–º–∏</div>
                                            <div class="payment-subtitle">–ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏</div>
                                            <div class="payment-badge">–ë–µ–∑ –∫–æ–º–∏—Å—Å–∏–∏</div>
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- –ö–∞—Ä—Ç–æ–π –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ -->
                                <div class="col-md-6 col-lg-4">
                                    <div class="payment-method-card" data-payment="card">
                                        <input type="radio" name="payment_method" id="card" value="card" onchange="togglePayment()" class="payment-radio">
                                        <label for="card" class="payment-label">
                                            <div class="payment-icon">
                                                <i class="fas fa-credit-card fa-2x"></i>
                                            </div>
                                            <div class="payment-title">–ö–∞—Ä—Ç–æ–π</div>
                                            <div class="payment-subtitle">–ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏</div>
                                            <div class="payment-badge">–ë–µ–∑ –∫–æ–º–∏—Å—Å–∏–∏</div>
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- –û–Ω–ª–∞–π–Ω –æ–ø–ª–∞—Ç–∞ YooMoney (–Ω–µ–∞–∫—Ç–∏–≤–Ω–∞) -->
                                <div class="col-md-6 col-lg-4">
                                    <div class="payment-method-card" data-payment="online" style="opacity: 0.6; cursor: not-allowed;">
                                        <input type="radio" name="payment_method" id="online" value="online" onchange="togglePayment()" class="payment-radio" disabled>
                                        <label for="online" class="payment-label" style="cursor: not-allowed;">
                                            <div class="payment-icon">
                                                <i class="fas fa-mobile-alt fa-2x"></i>
                                            </div>
                                            <div class="payment-title">–û–Ω–ª–∞–π–Ω</div>
                                            <div class="payment-subtitle">YooMoney</div>
                                            <div class="payment-badge" style="background: #6c757d;">–°–∫–æ—Ä–æ</div>
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- –°–ë–ü (–°–∏—Å—Ç–µ–º–∞ –±—ã—Å—Ç—Ä—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π) - –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞ -->
                                <div class="col-md-6 col-lg-4">
                                    <div class="payment-method-card" data-payment="sbp" style="opacity: 0.6; cursor: not-allowed;">
                                        <input type="radio" name="payment_method" id="sbp" value="sbp" onchange="togglePayment()" class="payment-radio" disabled>
                                        <label for="sbp" class="payment-label" style="cursor: not-allowed;">
                                            <div class="payment-icon">
                                                <i class="fas fa-qrcode fa-2x"></i>
                                            </div>
                                            <div class="payment-title">–°–ë–ü</div>
                                            <div class="payment-subtitle">–ë—ã—Å—Ç—Ä—ã–µ –ø–ª–∞—Ç–µ–∂–∏</div>
                                            <div class="payment-badge" style="background: #6c757d;">–°–∫–æ—Ä–æ</div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- –°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã -->
                            {% if payment_methods %}
                            <div class="mt-4">
                                <h6 class="text-muted mb-3">
                                    <i class="fas fa-bookmark me-2"></i>–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã
                                </h6>
                                <div class="row g-3 saved-cards-grid">
                                    {% for pm in payment_methods %}
                                    <div class="col-md-6 col-lg-4">
                                        <div class="payment-method-card saved-card" data-payment="saved:{{ pm.id }}">
                                            <input type="radio" name="payment_method" id="saved_pm_{{ pm.id }}" value="saved:{{ pm.id }}" onchange="togglePayment()" class="payment-radio">
                                            <label for="saved_pm_{{ pm.id }}" class="payment-label">
                                                <div class="payment-icon">
                                                    {% if pm.brand == 'Visa' %}
                                                        <i class="fab fa-cc-visa fa-2x text-primary"></i>
                                                    {% elif pm.brand == 'MasterCard' %}
                                                        <i class="fab fa-cc-mastercard fa-2x text-danger"></i>
                                                    {% else %}
                                                        <i class="fas fa-credit-card fa-2x"></i>
                                                    {% endif %}
                                                </div>
                                                <div class="payment-title">{{ pm.brand }}</div>
                                                <div class="payment-subtitle">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ {{ pm.last4 }}</div>
                                                <div class="payment-subtitle small">{{ pm.expiry_month }}/{{ pm.expiry_year }}</div>
                                                {% if pm.is_default %}
                                                    <div class="payment-badge payment-badge-default">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</div>
                                                {% endif %}
                                            </label>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- –î–∞–Ω–Ω—ã–µ –±–∞–Ω–∫–æ–≤—Å–∫–æ–π –∫–∞—Ä—Ç—ã -->
                        <div class="mb-4" id="card-details" style="display: none;">
                            <h6 class="text-zhevzhik-pink mb-3">–î–∞–Ω–Ω—ã–µ –±–∞–Ω–∫–æ–≤—Å–∫–æ–π –∫–∞—Ä—Ç—ã</h6>
                            <div class="row">
                                <div class="col-md-8 mb-3">
                                    <label for="card_number" class="form-label">–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã *</label>
                                    <input type="text" class="form-control" id="card_number" name="card_number" 
                                           placeholder="1234 5678 9012 3456" maxlength="19">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="card_cvv" class="form-label">CVV *</label>
                                    <input type="text" class="form-control" id="card_cvv" name="card_cvv" 
                                           placeholder="123" maxlength="3">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="card_expiry" class="form-label">–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è *</label>
                                    <input type="text" class="form-control" id="card_expiry" name="card_expiry" 
                                           placeholder="MM/YY" maxlength="5">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="card_holder" class="form-label">–ò–º—è –≤–ª–∞–¥–µ–ª—å—Ü–∞ *</label>
                                    <input type="text" class="form-control" id="card_holder" name="card_holder" 
                                           placeholder="IVAN IVANOV">
                                </div>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="save_card" name="save_card">
                                <label class="form-check-label" for="save_card">
                                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã –¥–ª—è –±—É–¥—É—â–∏—Ö –ø–æ–∫—É–ø–æ–∫
                                </label>
                            </div>
                        </div>
                        
                        <!-- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–µ—à–±—ç–∫–∞ -->
                        {% if cashback_balance > 0 %}
                        <div class="mb-4">
                            <div class="card border-zhevzhik-pink">
                                <div class="card-body">
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="use_cashback" name="use_cashback" onchange="toggleCashback()">
                                        <label class="form-check-label" for="use_cashback">
                                            <strong><i class="fas fa-coins text-warning me-2"></i>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–µ—à–±—ç–∫</strong>
                                            <br><small class="text-muted">–î–æ—Å—Ç—É–ø–Ω–æ: {{ cashback_balance|floatformat:0 }} ‚ÇΩ</small>
                                        </label>
                                    </div>
                                    <div id="cashback-amount-input" style="display: none;">
                                        <label for="cashback_amount" class="form-label">–°—É–º–º–∞ –∫–µ—à–±—ç–∫–∞ –¥–ª—è –æ–ø–ª–∞—Ç—ã (‚ÇΩ)</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="cashback_amount" name="cashback_amount" 
                                                   min="0" max="{{ cashback_balance }}" step="0.01" 
                                                   placeholder="0" oninput="updateTotalAmount()">
                                            <button type="button" class="btn btn-outline-secondary" onclick="useMaxCashback()">
                                                –ú–∞–∫—Å
                                            </button>
                                        </div>
                                        <small class="text-muted">–ú–∞–∫—Å–∏–º—É–º: {{ cashback_balance|floatformat:0 }} ‚ÇΩ</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–∫–∞–∑—É -->
                        <div class="mb-4">
                            <label for="comment" class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–∫–∞–∑—É</label>
                            <textarea class="form-control" id="comment" name="comment" rows="3" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è –∫ –∑–∞–∫–∞–∑—É"></textarea>
                        </div>
                        
                        <!-- –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –¥–ª—è –ø—Ä–æ–º–æ–∫–æ–¥–∞ –∏ –∞–∫—Ü–∏–∏ -->
                        {% if applied_promo_code %}
                        <input type="hidden" name="promo_code" value="{{ applied_promo_code.code }}">
                        {% endif %}
                        {% if selected_promotion_id %}
                        <input type="hidden" name="promotion_id" value="{{ selected_promotion_id }}">
                        {% endif %}
                        
                        <button type="submit" class="btn btn-zhevzhik-pink btn-lg w-100" id="submit-order-btn">
                            <i class="fas fa-credit-card"></i> –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑
                        </button>
                        
                        <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
                        <div id="loading-indicator" style="display: none;" class="text-center mt-3">
                            <div class="spinner-border text-zhevzhik-pink" role="status">
                                <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                            </div>
                            <p class="mt-2 text-muted">–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∑–∞–∫–∞–∑...</p>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- –ò—Ç–æ–≥–∏ –∑–∞–∫–∞–∑–∞ -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header bg-zhevzhik-yellow text-dark">
                    <h5 class="mb-0">–í–∞—à –∑–∞–∫–∞–∑</h5>
                </div>
                <div class="card-body">
                    <!-- –ü—Ä–æ–º–æ–∫–æ–¥ –∏ –≤—ã–±–æ—Ä –∞–∫—Ü–∏–∏ -->
                    <form method="get" class="mb-3">
                        <div class="input-group">
                            <input type="text" name="promo_code" class="form-control" placeholder="–ü—Ä–æ–º–æ–∫–æ–¥" value="{{ applied_promo_code.code|default:'' }}">
                            <button class="btn btn-outline-secondary" type="submit">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                        </div>
                        {% if promo_message %}
                        <small class="text-danger">{{ promo_message }}</small>
                        {% endif %}
                        {% if promotions_with_saving %}
                        <div class="mt-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="promotion_id" id="promo_none" value="" {% if not selected_promotion_id %}checked{% endif %}>
                                <label class="form-check-label" for="promo_none">–ù–µ –ø—Ä–∏–º–µ–Ω—è—Ç—å –∞–∫—Ü–∏—é</label>
                            </div>
                            {% for p in promotions_with_saving %}
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="promotion_id" id="promo_{{ p.promo.id }}" value="{{ p.promo.id }}" {% if selected_promotion_id == p.promo.id %}checked{% endif %}>
                                    <label class="form-check-label" for="promo_{{ p.promo.id }}">
                                        {{ p.promo.name }} ‚Äî —ç–∫–æ–Ω–æ–º–∏—è –¥–æ {{ p.saving|floatformat:0 }} ‚ÇΩ
                                    </label>
                                </div>
                            {% endfor %}
                            <button class="btn btn-outline-secondary btn-sm mt-2" type="submit">–û–±–Ω–æ–≤–∏—Ç—å</button>
                        </div>
                        {% endif %}
                    </form>

                    {% for item in cart_items %}
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h6 class="mb-1">{{ item.product.name }}</h6>
                            <small class="text-muted">{{ item.quantity }} —à—Ç. √ó {{ item.product.price }} ‚ÇΩ</small>
                        </div>
                        <span class="fw-bold">{{ item.total_price }} ‚ÇΩ</span>
                    </div>
                    {% endfor %}
                    
                    <hr>
                    
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>–¢–æ–≤–∞—Ä—ã:</span>
                        <span id="subtotal-cost">{{ total|floatformat:0 }} ‚ÇΩ</span>
                    </div>
                    {% if favorite_discount_amount and favorite_discount_amount > 0 %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>–°–∫–∏–¥–∫–∞ –ª—é–±–∏–º—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π:</span>
                        <span class="text-success">-{{ favorite_discount_amount|floatformat:0 }} ‚ÇΩ</span>
                    </div>
                    {% endif %}
                    {% if favorite_products_discount and favorite_products_discount > 0 %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>–°–∫–∏–¥–∫–∞ –Ω–∞ –ª—é–±–∏–º—ã–µ —Ç–æ–≤–∞—Ä—ã (10%):</span>
                        <span class="text-success">-{{ favorite_products_discount|floatformat:0 }} ‚ÇΩ</span>
                    </div>
                    {% endif %}
                    {% if applied_promo_code %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>–ü—Ä–æ–º–æ–∫–æ–¥ "{{ applied_promo_code.code }}":</span>
                        <span class="text-success">-{{ promotion_discount|floatformat:0 }} ‚ÇΩ</span>
                    </div>
                    {% elif promotion_discount and promotion_discount > 0 %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>–°–∫–∏–¥–∫–∞ –ø–æ –∞–∫—Ü–∏–∏:</span>
                        <span class="text-success">-{{ promotion_discount|floatformat:0 }} ‚ÇΩ</span>
                    </div>
                    {% endif %}
                    <div id="cashback-discount" class="d-flex justify-content-between align-items-center mb-2" style="display: none;">
                        <span>–ö–µ—à–±—ç–∫:</span>
                        <span class="text-success">-0 ‚ÇΩ</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>–î–æ—Å—Ç–∞–≤–∫–∞:
                            {% if free_delivery_threshold %}
                            <small class="text-muted">(–±–µ—Å–ø–ª–∞—Ç–Ω–æ –æ—Ç {{ free_delivery_threshold }} ‚ÇΩ)</small>
                            {% endif %}
                        </span>
                        <span id="delivery-cost">{{ delivery_display_cost|floatformat:0 }} ‚ÇΩ</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center">
                        <strong>–ò—Ç–æ–≥–æ:</strong>
                        <strong id="total-cost">{{ computed_total|floatformat:0 }} ‚ÇΩ</strong>
                    </div>
                </div>
            </div>
            
            <!-- –î–æ—Å—Ç—É–ø–Ω—ã–µ –∞–∫—Ü–∏–∏ -->
            {% if promotions_with_saving %}
            <div class="card mt-3">
                <div class="card-header bg-light">
                    <h6 class="mb-0">–î–æ—Å—Ç—É–ø–Ω—ã–µ –∞–∫—Ü–∏–∏</h6>
                </div>
                <div class="card-body">
                    {% for p in promotions_with_saving %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <strong>{{ p.promo.name }}</strong>
                            <div class="text-muted small">{{ p.promo.description }}</div>
                        </div>
                        <span class="text-success">–≠–∫–æ–Ω–æ–º–∏—è –¥–æ {{ p.saving|floatformat:0 }} ‚ÇΩ</span>
                    </div>
                    {% empty %}
                    <div class="text-muted">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–∫—Ü–∏–π</div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <!-- –ö–æ–Ω—Ç–∞–∫—Ç—ã -->
            <div class="card mt-3">
                <div class="card-body">
                    <h6 class="text-zhevzhik-pink">–ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å?</h6>
                    <p class="mb-2">üìû +7 (495) 123-45-67</p>
                    <p class="mb-0">‚úâÔ∏è info@zhevzhik.ru</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const checkoutRoot = document.getElementById('checkout-root');
    const deliveryType = document.querySelectorAll('input[name="delivery_type"]');
    const paymentMethod = document.querySelectorAll('input[name="payment_method"]');
    const deliveryAddress = document.getElementById('delivery-address');
    const cardDetails = document.getElementById('card-details');
    const deliveryCost = document.getElementById('delivery-cost');
    const totalCost = document.getElementById('total-cost');
    const baseTotal = parseFloat(checkoutRoot?.dataset.baseTotal || '0');
    const freeDeliveryThreshold = parseFloat(checkoutRoot?.dataset.freeThreshold || '5000');
    const maxCashbackBalance = parseFloat(checkoutRoot?.dataset.cashbackBalance || '0');
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–µ—à–±—ç–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    if (typeof toggleCashback === 'function') {
        toggleCashback();
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏—Ç–æ–≥–æ–≤–æ–π —Å—É–º–º—ã
    function updateTotalAmount() {
        console.log('[CHECKOUT] updateTotalAmount called');
        const selectedDelivery = document.querySelector('input[name="delivery_type"]:checked');
        console.log('[CHECKOUT] Selected delivery type:', selectedDelivery?.value);
        let finalAmount = baseTotal;
        let deliveryFee = 0;
        
        if (selectedDelivery && selectedDelivery.value === 'delivery') {
            deliveryFee = baseTotal >= freeDeliveryThreshold ? 0 : 200;
            finalAmount = baseTotal + deliveryFee;
            console.log('[CHECKOUT] Delivery selected, fee:', deliveryFee, 'baseTotal:', baseTotal, 'freeDeliveryThreshold:', freeDeliveryThreshold);
        } else {
            // –°–∞–º–æ–≤—ã–≤–æ–∑ - –¥–æ—Å—Ç–∞–≤–∫–∞ –±–µ—Å–ø–ª–∞—Ç–Ω–∞
            deliveryFee = 0;
            finalAmount = baseTotal;
            console.log('[CHECKOUT] Pickup selected, no delivery fee');
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –¥–æ—Å—Ç–∞–≤–∫–∏
        if (deliveryCost) {
            if (selectedDelivery && selectedDelivery.value === 'delivery') {
                deliveryCost.textContent = (baseTotal >= freeDeliveryThreshold) ? '0 ‚ÇΩ' : '200 ‚ÇΩ';
                deliveryCost.className = baseTotal >= freeDeliveryThreshold ? 'text-success' : '';
            } else {
                deliveryCost.textContent = '0 ‚ÇΩ';
                deliveryCost.className = '';
            }
            console.log('[CHECKOUT] Delivery cost display updated:', deliveryCost.textContent);
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –≤ –æ–ø–∏—Å–∞–Ω–∏–∏ —Å–ø–æ—Å–æ–±–∞ –¥–æ—Å—Ç–∞–≤–∫–∏
        const deliveryPriceText = document.getElementById('delivery-price-text');
        if (deliveryPriceText) {
            if (selectedDelivery && selectedDelivery.value === 'delivery') {
                deliveryPriceText.textContent = (baseTotal >= freeDeliveryThreshold) ? '–±–µ—Å–ø–ª–∞—Ç–Ω–æ' : '200 ‚ÇΩ';
            }
        }
        
        // –£—á–∏—Ç—ã–≤–∞–µ–º –∫–µ—à–±—ç–∫, –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
        const useCashback = document.getElementById('use_cashback')?.checked;
        console.log('[CHECKOUT] use_cashback checked:', useCashback);
        let cashbackAmount = 0;
        if (useCashback) {
            const cashbackInput = document.getElementById('cashback_amount');
            console.log('[CHECKOUT] cashback_amount input exists:', !!cashbackInput, 'value:', cashbackInput?.value);
            if (cashbackInput) {
                cashbackAmount = parseFloat(cashbackInput.value) || 0;
                const maxCashback = maxCashbackBalance;
                console.log('[CHECKOUT] cashbackAmount before limit:', cashbackAmount, 'maxCashback:', maxCashback, 'finalAmount:', finalAmount);
                cashbackAmount = Math.min(cashbackAmount, maxCashback, finalAmount);
                console.log('[CHECKOUT] cashbackAmount after limit:', cashbackAmount);
            }
        }
        finalAmount = Math.max(0, finalAmount - cashbackAmount);
        console.log('[CHECKOUT] Final amount after cashback:', finalAmount);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–µ—à–±—ç–∫–∞ –≤ –∏—Ç–æ–≥–∞—Ö
        const cashbackDisplay = document.getElementById('cashback-discount');
        if (cashbackDisplay) {
            if (cashbackAmount > 0) {
                cashbackDisplay.style.display = 'flex';
                cashbackDisplay.querySelector('span:last-child').textContent = `-${Math.round(cashbackAmount).toLocaleString('ru-RU')} ‚ÇΩ`;
                console.log('[CHECKOUT] Cashback display shown:', cashbackAmount);
            } else {
                cashbackDisplay.style.display = 'none';
                console.log('[CHECKOUT] Cashback display hidden');
            }
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Ç–æ–≥–æ–≤—É—é —Å—É–º–º—É —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
        if (totalCost) {
            totalCost.textContent = Math.round(finalAmount).toLocaleString('ru-RU') + ' ‚ÇΩ';
            console.log('[CHECKOUT] Total cost updated:', totalCost.textContent);
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ total_amount
        let totalAmountInput = document.querySelector('input[name="total_amount"]');
        if (!totalAmountInput) {
            totalAmountInput = document.createElement('input');
            totalAmountInput.type = 'hidden';
            totalAmountInput.name = 'total_amount';
            document.querySelector('form').appendChild(totalAmountInput);
        }
        totalAmountInput.value = finalAmount;
        console.log('[CHECKOUT] total_amount hidden input updated:', totalAmountInput.value);
        
        return finalAmount;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∫–µ—à–±—ç–∫–∞
    window.toggleCashback = function() {
        console.log('[CHECKOUT] toggleCashback called');
        const useCashback = document.getElementById('use_cashback');
        const cashbackInput = document.getElementById('cashback-amount-input');
        console.log('[CHECKOUT] use_cashback checkbox:', useCashback?.checked, 'cashback-amount-input exists:', !!cashbackInput);
        
        if (cashbackInput) {
            if (useCashback && useCashback.checked) {
                cashbackInput.style.display = 'block';
                console.log('[CHECKOUT] cashback input displayed');
                const cashbackAmountInput = document.getElementById('cashback_amount');
                if (cashbackAmountInput) {
                    cashbackAmountInput.focus();
                    console.log('[CHECKOUT] cashback_amount input focused');
                }
            } else {
                cashbackInput.style.display = 'none';
                // –û—á–∏—â–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–∏ —Å–Ω—è—Ç–∏–∏ —á–µ–∫–±–æ–∫—Å–∞
                const cashbackAmountInput = document.getElementById('cashback_amount');
                if (cashbackAmountInput) {
                    cashbackAmountInput.value = '';
                }
                console.log('[CHECKOUT] cashback input hidden');
            }
        } else {
            console.error('[CHECKOUT] CASHBACK ERROR: cashback-amount-input element not found!');
        }
        updateTotalAmount();
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–µ—à–±—ç–∫–∞
    window.useMaxCashback = function() {
        const cashbackInput = document.getElementById('cashback_amount');
        const maxCashback = parseFloat('{{ cashback_balance|default:0 }}') || 0;
        if (cashbackInput) {
            cashbackInput.value = maxCashback;
            updateTotalAmount();
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–µ–≤—å—é –∞–¥—Ä–µ—Å–∞
    window.updateAddressPreview = function() {
        const addressSelect = document.getElementById('address_id');
        const previewDiv = document.getElementById('delivery-address-preview');
        const addressFull = document.getElementById('selected-address-full');
        
        if (!previewDiv || !addressFull) return;
        
        let addressText = '';
        let address = '';
        let entrance = '';
        let floor = '';
        let apartment = '';
        let intercom = '';
        let comment = '';
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—ã–±—Ä–∞–Ω –ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –∞–¥—Ä–µ—Å
        if (addressSelect && addressSelect.value) {
            const selectedOption = addressSelect.options[addressSelect.selectedIndex];
            if (selectedOption) {
                address = selectedOption.dataset.address || '';
                entrance = selectedOption.dataset.entrance || '';
                floor = selectedOption.dataset.floor || '';
                apartment = selectedOption.dataset.apartment || '';
                intercom = selectedOption.dataset.intercom || '';
                comment = selectedOption.dataset.comment || '';
            }
        } else {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤–≤–µ–¥–µ–Ω–Ω—ã–µ –≤—Ä—É—á–Ω—É—é –¥–∞–Ω–Ω—ã–µ
            const addressInput = document.getElementById('delivery_address');
            const entranceInput = document.getElementById('delivery_entrance');
            const floorInput = document.getElementById('delivery_floor');
            const apartmentInput = document.getElementById('delivery_apartment');
            
            if (addressInput) address = addressInput.value.trim();
            if (entranceInput) entrance = entranceInput.value.trim();
            if (floorInput) floor = floorInput.value.trim();
            if (apartmentInput) apartment = apartmentInput.value.trim();
        }
        
        if (address) {
            addressText = address;
            const details = [];
            if (entrance) details.push(`–ü–æ–¥—ä–µ–∑–¥ ${entrance}`);
            if (floor) details.push(`–≠—Ç–∞–∂ ${floor}`);
            if (apartment) details.push(`–ö–≤. ${apartment}`);
            if (intercom) details.push(`–î–æ–º–æ—Ñ–æ–Ω: ${intercom}`);
            if (details.length > 0) {
                addressText += ', ' + details.join(', ');
            }
            if (comment) {
                addressText += ` (${comment})`;
            }
            
            addressFull.textContent = addressText;
            previewDiv.style.display = 'block';
        } else {
            previewDiv.style.display = 'none';
        }
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ø–æ—Å–æ–±–∞ –ø–æ–ª—É—á–µ–Ω–∏—è
    window.toggleDelivery = function() {
        const selected = document.querySelector('input[name="delivery_type"]:checked');
        const deliveryAddressEl = document.getElementById('delivery-address');
        console.log('[CHECKOUT] toggleDelivery called, selected:', selected?.value, 'deliveryAddressEl:', !!deliveryAddressEl);
        
        if (selected && selected.value === 'delivery') {
            console.log('[CHECKOUT] Delivery selected, showing address fields');
            if (deliveryAddressEl) {
                deliveryAddressEl.style.display = 'block';
                // –î–µ–ª–∞–µ–º –∞–¥—Ä–µ—Å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º –ø—Ä–∏ –¥–æ—Å—Ç–∞–≤–∫–µ
                const addressInputs = deliveryAddressEl.querySelectorAll('input[required], select[required]');
                addressInputs.forEach(input => input.setAttribute('required', 'required'));
                // –ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω
                const deliveryAddressInput = document.getElementById('delivery_address');
                if (deliveryAddressInput) {
                    deliveryAddressInput.setAttribute('required', 'required');
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø–æ–ª–Ω–µ–Ω –ª–∏ –∞–¥—Ä–µ—Å
                    if (!deliveryAddressInput.value || !deliveryAddressInput.value.trim()) {
                        console.error('[CHECKOUT] DELIVERY ERROR: –ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω!');
                        const addressSelect = document.getElementById('address_id');
                        if (!addressSelect || !addressSelect.value) {
                            console.error('[CHECKOUT] DELIVERY ERROR: –ù–µ –≤—ã–±—Ä–∞–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –∞–¥—Ä–µ—Å –∏ –Ω–µ –≤–≤–µ–¥–µ–Ω –Ω–æ–≤—ã–π –∞–¥—Ä–µ—Å!');
                        }
                    }
                }
            } else {
                console.error('[CHECKOUT] DELIVERY ERROR: deliveryAddress element not found!');
            }
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é –∞–¥—Ä–µ—Å–∞, –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω
            updateAddressPreview();
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–≤—å—é –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∞–¥—Ä–µ—Å–∞
            const addressInputs = ['delivery_address', 'delivery_entrance', 'delivery_floor', 'delivery_apartment'];
            addressInputs.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('input', updateAddressPreview);
                    input.addEventListener('change', updateAddressPreview);
                }
            });
        } else {
            console.log('[CHECKOUT] Pickup selected, hiding address fields');
            if (deliveryAddressEl) {
                deliveryAddressEl.style.display = 'none';
                // –£–±–∏—Ä–∞–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–∏ —Å–∞–º–æ–≤—ã–≤–æ–∑–µ
                const addressInputs = deliveryAddressEl.querySelectorAll('input[required], select[required]');
                addressInputs.forEach(input => input.removeAttribute('required'));
                const deliveryAddressInput = document.getElementById('delivery_address');
                if (deliveryAddressInput) deliveryAddressInput.removeAttribute('required');
            }
            // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é –∞–¥—Ä–µ—Å–∞
            const previewDiv = document.getElementById('delivery-address-preview');
            if (previewDiv) previewDiv.style.display = 'none';
        }
        try { 
            localStorage.setItem('checkout_delivery_type', selected ? selected.value : 'pickup'); 
        } catch(e) {}
        updateTotalAmount();
    }
    deliveryType.forEach(radio => radio.addEventListener('change', toggleDelivery));

    // –ü–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ –∞–¥—Ä–µ—Å–∞
    const addressSelect = document.getElementById('address_id');
    if (addressSelect) {
        addressSelect.addEventListener('change', function() {
            console.log('[CHECKOUT] Address select changed, value:', this.value);
            const isNew = this.value === '';
            const selectedOption = this.options[this.selectedIndex];
            console.log('[CHECKOUT] Selected option:', selectedOption?.text, 'isNew:', isNew);
            
            if (!isNew && selectedOption) {
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è –∞–¥—Ä–µ—Å–∞ –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∞–¥—Ä–µ—Å–∞
                const addressInput = document.getElementById('delivery_address');
                const entranceInput = document.getElementById('delivery_entrance');
                const apartmentInput = document.getElementById('delivery_apartment');
                const floorInput = document.getElementById('delivery_floor');
                
                const address = selectedOption.dataset.address || '';
                const entrance = selectedOption.dataset.entrance || '';
                const apartment = selectedOption.dataset.apartment || '';
                const floor = selectedOption.dataset.floor || '';
                
                console.log('[CHECKOUT] Setting address fields:', {address, entrance, apartment, floor});
                
                if (addressInput) {
                    addressInput.value = address;
                    addressInput.readOnly = true;
                    console.log('[CHECKOUT] delivery_address set to:', addressInput.value, 'readOnly:', addressInput.readOnly);
                }
                if (entranceInput) {
                    entranceInput.value = entrance;
                    entranceInput.readOnly = true;
                    console.log('[CHECKOUT] delivery_entrance set to:', entranceInput.value);
                }
                if (apartmentInput) {
                    apartmentInput.value = apartment;
                    apartmentInput.readOnly = true;
                    console.log('[CHECKOUT] delivery_apartment set to:', apartmentInput.value);
                }
                if (floorInput) {
                    floorInput.value = floor;
                    floorInput.readOnly = true;
                    console.log('[CHECKOUT] delivery_floor set to:', floorInput.value);
                }
                if (document.getElementById('save_address')) document.getElementById('save_address').disabled = true;
            } else {
                // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–ª—è –¥–ª—è –Ω–æ–≤–æ–≥–æ –∞–¥—Ä–µ—Å–∞
                console.log('[CHECKOUT] New address selected, unlocking fields');
                const addressInput = document.getElementById('delivery_address');
                const entranceInput = document.getElementById('delivery_entrance');
                const apartmentInput = document.getElementById('delivery_apartment');
                const floorInput = document.getElementById('delivery_floor');
                
                if (addressInput) {
                    addressInput.readOnly = false;
                    console.log('[CHECKOUT] delivery_address unlocked');
                }
                if (entranceInput) entranceInput.readOnly = false;
                if (apartmentInput) apartmentInput.readOnly = false;
                if (floorInput) floorInput.readOnly = false;
                if (document.getElementById('save_address')) document.getElementById('save_address').disabled = false;
            }
            
            try { localStorage.setItem('checkout_address_id', this.value || ''); } catch(e) {}
            updateAddressPreview();
        });
    }
    const defaultAddressId = checkoutRoot?.dataset.defaultAddressId || '';
    if (defaultAddressId && addressSelect) {
        addressSelect.value = defaultAddressId;
        addressSelect.dispatchEvent(new Event('change'));
    } else {
        updateAddressPreview();
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã
    window.togglePayment = function() {
        const selected = document.querySelector('input[name="payment_method"]:checked');
        const isOnline = selected && !selected.disabled && (selected.value === 'online' || selected.value === 'sbp' || selected.value.startsWith('saved:'));
        const isSavedCard = selected && selected.value.startsWith('saved:');
        const isSBP = selected && selected.value === 'sbp';
        const isCashback = selected && selected.value === 'cashback';
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫
        document.querySelectorAll('.payment-method-card').forEach(card => {
            card.classList.remove('selected');
        });
        if (selected) {
            const cardElement = selected.closest('.payment-method-card');
            if (cardElement) {
                cardElement.classList.add('selected');
            }
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª—è –¥–ª—è –≤–≤–æ–¥–∞ –∫–∞—Ä—Ç—ã
        if (isOnline && !isSavedCard && !isSBP) {
            if (cardDetails) {
                cardDetails.style.display = 'block';
                const cardFields = cardDetails.querySelectorAll('input[type="text"]');
                cardFields.forEach(field => field.setAttribute('required', 'required'));
            }
        } else {
            if (cardDetails) {
                cardDetails.style.display = 'none';
                const cardFields = cardDetails.querySelectorAll('input[type="text"]');
                cardFields.forEach(field => field.removeAttribute('required'));
            }
        }
        
        try { localStorage.setItem('checkout_payment_method', selected ? selected.value : 'cash'); } catch(e) {}
    }
    paymentMethod.forEach(radio => radio.addEventListener('change', togglePayment));
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –≤—ã–¥–µ–ª–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    const initialPayment = document.querySelector('input[name="payment_method"]:checked');
    if (initialPayment) {
        const cardElement = initialPayment.closest('.payment-method-card');
        if (cardElement) {
            cardElement.classList.add('selected');
        }
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞
    try {
        const savedDelivery = localStorage.getItem('checkout_delivery_type');
        if (savedDelivery) {
            const el = document.querySelector('input[name="delivery_type"][value="' + savedDelivery + '"]');
            if (el) el.checked = true;
        }
        const savedPayment = localStorage.getItem('checkout_payment_method');
        if (savedPayment) {
            const el2 = document.querySelector('input[name="payment_method"][value="' + savedPayment + '"]');
            if (el2) el2.checked = true;
        }
        const savedAddressId = localStorage.getItem('checkout_address_id');
        if (savedAddressId && document.getElementById('address_id')) {
            document.getElementById('address_id').value = savedAddressId;
        }
        const savedSlot = localStorage.getItem('checkout_delivery_slot');
        if (savedSlot && document.getElementById('delivery_slot_id')) {
            document.getElementById('delivery_slot_id').value = savedSlot;
        }
    } catch(e) {}
    toggleDelivery();
    togglePayment();
    toggleCashback(); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–ª–µ –∫–µ—à–±—ç–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∏—Ç–æ–≥–æ–≤—É—é —Å—É–º–º—É —Å—Ä–∞–∑—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    updateTotalAmount();

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–ª–æ—Ç–∞
    const slotSel = document.getElementById('delivery_slot_id');
    if (slotSel) slotSel.addEventListener('change', function(){ try { localStorage.setItem('checkout_delivery_slot', this.value || ''); } catch(e) {} });
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ –∫–∞—Ä—Ç—ã
    const cardNumber = document.getElementById('card_number');
    if (cardNumber) {
        cardNumber.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
            let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
            if (formattedValue.length > 19) {
                formattedValue = formattedValue.substr(0, 19);
            }
            e.target.value = formattedValue;
        });
    }
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è –∫–∞—Ä—Ç—ã
    const cardExpiry = document.getElementById('card_expiry');
    if (cardExpiry) {
        cardExpiry.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2, 4);
            }
            e.target.value = value;
        });
    }
    
    // –¢–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã –¥–ª—è CVV
    const cardCvv = document.getElementById('card_cvv');
    if (cardCvv) {
        cardCvv.addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
        });
    }
    
    // –ó–∞–≥–ª–∞–≤–Ω—ã–µ –±—É–∫–≤—ã –¥–ª—è –∏–º–µ–Ω–∏ –≤–ª–∞–¥–µ–ª—å—Ü–∞
    const cardHolder = document.getElementById('card_holder');
    if (cardHolder) {
        cardHolder.addEventListener('input', function(e) {
            e.target.value = e.target.value.toUpperCase();
        });
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
    const orderForm = document.querySelector('form');
    const submitBtn = document.getElementById('submit-order-btn');
    const loadingIndicator = document.getElementById('loading-indicator');
    
    if (!orderForm) {
        console.error('Form not found!');
        return;
    }
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∫–∞—Ä—Ç—ã
    function validateCard(cardNumber, cardExpiry, cardCvv, cardHolder) {
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–º–µ—Ä–∞ –∫–∞—Ä—Ç—ã (–º–∏–Ω–∏–º—É–º 13 —Ü–∏—Ñ—Ä, –º–∞–∫—Å–∏–º—É–º 19)
        const cardNumberClean = cardNumber.replace(/\s/g, '');
        if (cardNumberClean.length < 13 || cardNumberClean.length > 19) {
            return { valid: false, message: '–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –æ—Ç 13 –¥–æ 19 —Ü–∏—Ñ—Ä' };
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è (—Ñ–æ—Ä–º–∞—Ç MM/YY)
        const expiryRegex = /^(0[1-9]|1[0-2])\/([0-9]{2})$/;
        if (!expiryRegex.test(cardExpiry)) {
            return { valid: false, message: '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è –∫–∞—Ä—Ç—ã (MM/YY)' };
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –Ω–µ –∏—Å—Ç–µ–∫
        const [month, year] = cardExpiry.split('/');
        const expiryDate = new Date(2000 + parseInt(year), parseInt(month) - 1);
        const now = new Date();
        if (expiryDate < now) {
            return { valid: false, message: '–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –∫–∞—Ä—Ç—ã –∏—Å—Ç–µ–∫' };
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ CVV (3-4 —Ü–∏—Ñ—Ä—ã)
        if (!/^\d{3,4}$/.test(cardCvv)) {
            return { valid: false, message: 'CVV –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 3 –∏–ª–∏ 4 —Ü–∏—Ñ—Ä—ã' };
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–µ–Ω–∏ –≤–ª–∞–¥–µ–ª—å—Ü–∞ (–º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞)
        if (!cardHolder || cardHolder.trim().length < 2) {
            return { valid: false, message: '–í–≤–µ–¥–∏—Ç–µ –∏–º—è –≤–ª–∞–¥–µ–ª—å—Ü–∞ –∫–∞—Ä—Ç—ã' };
        }
        
        return { valid: true };
    }
    
    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ
    function showError(message) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'alert alert-danger alert-dismissible fade show mt-3';
        errorDiv.innerHTML = `
            <strong>–û—à–∏–±–∫–∞:</strong> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        orderForm.insertBefore(errorDiv, orderForm.firstChild);
        setTimeout(() => errorDiv.remove(), 5000);
    }
    
    orderForm.addEventListener('submit', function(e) {
        const paymentMethod = document.querySelector('input[name="payment_method"]:checked');
        
        if (!paymentMethod) {
            e.preventDefault();
            showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã');
            return;
        }
        
        // –î–ª—è –≤—Å–µ—Ö –æ–Ω–ª–∞–π–Ω-—Å–ø–æ—Å–æ–±–æ–≤ –æ–ø–ª–∞—Ç—ã –≤—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã
        // –ù–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ disabled
        const isOnlinePayment = !paymentMethod.disabled && (
            paymentMethod.value === 'online' || 
            paymentMethod.value === 'sbp' || 
            (paymentMethod.value && paymentMethod.value.indexOf('saved:') === 0)
        );
        
        if (isOnlinePayment) {
            e.preventDefault(); // –í—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É –¥–ª—è –æ–Ω–ª–∞–π–Ω-–æ–ø–ª–∞—Ç—ã
        }
        
        // –î–ª—è –æ–ø–ª–∞—Ç—ã –∫–µ—à–±–µ–∫–æ–º —Ñ–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –æ–±—ã—á–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º
        // –ù–æ –∫–µ—à–±–µ–∫ - —ç—Ç–æ –Ω–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã, –∞ —á–µ–∫–±–æ–∫—Å!
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–∏ –∫–µ—à–±–µ–∫
        const useCashbackCheckbox = document.getElementById('use_cashback');
        const isUsingCashback = useCashbackCheckbox && useCashbackCheckbox.checked;
        console.log('[CHECKOUT] isUsingCashback:', isUsingCashback);
        
        if (isUsingCashback) {
            const cashbackAmountInput = document.getElementById('cashback_amount');
            const cashbackAmount = cashbackAmountInput ? parseFloat(cashbackAmountInput.value) || 0 : 0;
            console.log('[CHECKOUT] Cashback amount from input:', cashbackAmount);
            console.log('[CHECKOUT] Cashback input element:', cashbackAmountInput, 'value:', cashbackAmountInput?.value);
            
            if (cashbackAmount <= 0) {
                e.preventDefault();
                console.error('[CHECKOUT] CASHBACK ERROR: –ß–µ–∫–±–æ–∫—Å –∫–µ—à–±—ç–∫–∞ –æ—Ç–º–µ—á–µ–Ω, –Ω–æ —Å—É–º–º–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞ –∏–ª–∏ —Ä–∞–≤–Ω–∞ 0!');
                console.error('[CHECKOUT] CASHBACK ERROR: cashbackAmountInput exists:', !!cashbackAmountInput);
                console.error('[CHECKOUT] CASHBACK ERROR: cashbackAmountInput value:', cashbackAmountInput?.value);
                console.error('[CHECKOUT] CASHBACK ERROR: parsed cashbackAmount:', cashbackAmount);
                showError('–£–∫–∞–∂–∏—Ç–µ —Å—É–º–º—É –∫–µ—à–±—ç–∫–∞ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è');
                return;
            }
            
            const maxCashback = parseFloat('{{ cashback_balance|default:0 }}') || 0;
            if (cashbackAmount > maxCashback) {
                e.preventDefault();
                console.error('[CHECKOUT] CASHBACK ERROR: –°—É–º–º–∞ –∫–µ—à–±—ç–∫–∞ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã–π –±–∞–ª–∞–Ω—Å!');
                console.error('[CHECKOUT] CASHBACK ERROR: cashbackAmount:', cashbackAmount, 'maxCashback:', maxCashback);
                showError(`–°—É–º–º–∞ –∫–µ—à–±—ç–∫–∞ –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–µ–≤—ã—à–∞—Ç—å ${maxCashback} ‚ÇΩ`);
                return;
            }
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥—Ä–µ—Å–∞ –ø—Ä–∏ –¥–æ—Å—Ç–∞–≤–∫–µ
        const deliveryType = document.querySelector('input[name="delivery_type"]:checked')?.value;
        if (deliveryType === 'delivery') {
            const addressId = document.getElementById('address_id')?.value;
            const deliveryAddressInput = document.getElementById('delivery_address');
            const deliveryAddress = deliveryAddressInput?.value || '';
            
            console.log('[CHECKOUT] Delivery selected, checking address:', {
                addressId: addressId,
                deliveryAddress: deliveryAddress,
                addressInputExists: !!deliveryAddressInput
            });
            
            if (!addressId && (!deliveryAddress || !deliveryAddress.trim())) {
                e.preventDefault();
                console.error('[CHECKOUT] DELIVERY ERROR: –î–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –∞–¥—Ä–µ—Å!');
                console.error('[CHECKOUT] DELIVERY ERROR: addressId:', addressId, 'deliveryAddress:', deliveryAddress);
                showError('–î–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –∞–¥—Ä–µ—Å');
                return;
            }
        }
        
        // –î–ª—è –Ω–∞–ª–∏—á–Ω—ã—Ö/–∫–∞—Ä—Ç—ã —Ñ–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –æ–±—ã—á–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º
        if (paymentMethod.value === 'cash' || paymentMethod.value === 'card') {
            console.log('[CHECKOUT] Cash/card payment, submitting form normally');
            submitBtn.style.display = 'none';
            loadingIndicator.style.display = 'block';
            // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã
            return;
        }
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ –æ–Ω–ª–∞–π–Ω –æ–ø–ª–∞—Ç–µ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ disabled)
        if (paymentMethod.value === 'online' && !paymentMethod.disabled) {
            const cardNumber = document.getElementById('card_number')?.value || '';
            const cardExpiry = document.getElementById('card_expiry')?.value || '';
            const cardCvv = document.getElementById('card_cvv')?.value || '';
            const cardHolder = document.getElementById('card_holder')?.value || '';
            
            const validation = validateCard(cardNumber, cardExpiry, cardCvv, cardHolder);
            if (!validation.valid) {
                showError(validation.message);
                return;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            submitBtn.style.display = 'none';
            loadingIndicator.style.display = 'block';
            
            // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ–ø–ª–∞—Ç—ã
            const formData = new FormData(orderForm);
            
            // –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Å—É–º–º—É —Å —É—á–µ—Ç–æ–º –¥–æ—Å—Ç–∞–≤–∫–∏
            const currentTotal = updateTotalAmount();
            formData.append('amount', currentTotal);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ YooMoney
            fetch('/yoomoney-payment/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // –ü–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–µ–Ω, –∑–∞–∫–∞–∑ —É–∂–µ —Å–æ–∑–¥–∞–Ω, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º
                    createOrderAfterPayment(data.payment_id, data.order_id);
                } else {
                    // –ü–ª–∞—Ç–µ–∂ –Ω–µ –ø—Ä–æ—à–µ–ª
                    showError('–û—à–∏–±–∫–∞ –æ–ø–ª–∞—Ç—ã: ' + (data.message || data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    submitBtn.style.display = 'block';
                    loadingIndicator.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–ª–∞—Ç–µ–∂–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
                submitBtn.style.display = 'block';
                loadingIndicator.style.display = 'none';
            });
        } else if (paymentMethod.value === 'sbp') {
            // –û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ –°–ë–ü
            e.preventDefault();
            
            submitBtn.style.display = 'none';
            loadingIndicator.style.display = 'block';
            
            // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ–ø–ª–∞—Ç—ã
            const formData = new FormData(orderForm);
            const currentTotal = updateTotalAmount();
            formData.append('amount', currentTotal);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –°–ë–ü
            fetch('/sbp-payment/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // –ü–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–µ–Ω, –∑–∞–∫–∞–∑ —É–∂–µ —Å–æ–∑–¥–∞–Ω, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º
                    createOrderAfterPayment(data.payment_id, data.order_id);
                } else {
                    showError('–û—à–∏–±–∫–∞ –æ–ø–ª–∞—Ç—ã: ' + (data.message || data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    submitBtn.style.display = 'block';
                    loadingIndicator.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–ª–∞—Ç–µ–∂–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
                submitBtn.style.display = 'block';
                loadingIndicator.style.display = 'none';
            });
        } else if (paymentMethod.value && paymentMethod.value.indexOf('saved:') === 0) {
            // –û–ø–ª–∞—Ç–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–π –∫–∞—Ä—Ç–æ–π - —Ç–æ–∂–µ —á–µ—Ä–µ–∑ –æ–Ω–ª–∞–π–Ω –æ–ø–ª–∞—Ç—É
            e.preventDefault();
            
            submitBtn.style.display = 'none';
            loadingIndicator.style.display = 'block';
            
            // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ–ø–ª–∞—Ç—ã
            const formData = new FormData(orderForm);
            const currentTotal = updateTotalAmount();
            formData.append('amount', currentTotal);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ YooMoney —Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–π –∫–∞—Ä—Ç–æ–π
            fetch('/yoomoney-payment/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // –ü–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–µ–Ω, –∑–∞–∫–∞–∑ —É–∂–µ —Å–æ–∑–¥–∞–Ω, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º
                    createOrderAfterPayment(data.payment_id, data.order_id);
                } else {
                    showError('–û—à–∏–±–∫–∞ –æ–ø–ª–∞—Ç—ã: ' + (data.message || data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    submitBtn.style.display = 'block';
                    loadingIndicator.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–ª–∞—Ç–µ–∂–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
                submitBtn.style.display = 'block';
                loadingIndicator.style.display = 'none';
            });
        } else {
            // –î–ª—è –¥—Ä—É–≥–∏—Ö —Å–ø–æ—Å–æ–±–æ–≤ –æ–ø–ª–∞—Ç—ã (–Ω–∞–ª–∏—á–Ω—ã–µ, –∫–∞—Ä—Ç–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏)
            submitBtn.style.display = 'none';
            loadingIndicator.style.display = 'block';
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∏—Ç–æ–≥–æ–≤—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å —Å —É—á–µ—Ç–æ–º –¥–æ—Å—Ç–∞–≤–∫–∏
            const currentTotal = updateTotalAmount();
            
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ –ø–æ–ª–µ –µ—Å–ª–∏ –µ—Å—Ç—å
            const oldTotalInput = orderForm.querySelector('input[name="total_amount"]');
            if (oldTotalInput) oldTotalInput.remove();
            
            // –°–æ–∑–¥–∞–µ–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è –∏—Ç–æ–≥–æ–≤–æ–π —Å—É–º–º—ã
            const totalInput = document.createElement('input');
            totalInput.type = 'hidden';
            totalInput.name = 'total_amount';
            totalInput.value = currentTotal;
            orderForm.appendChild(totalInput);
            
            // –§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è –æ–±—ã—á–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º
        }
    });
    
    // –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã
    function createOrderAfterPayment(paymentId, orderId) {
        // –ó–∞–∫–∞–∑ —É–∂–µ —Å–æ–∑–¥–∞–Ω –≤ yoomoney_payment_view, –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º
        if (orderId) {
            window.location.href = `/order-success/?order_id=${orderId}`;
        } else {
            // Fallback –Ω–∞ —Å—Ç–∞—Ä—É—é –ª–æ–≥–∏–∫—É –µ—Å–ª–∏ order_id –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω
            window.location.href = '/order-success/';
        }
    }
    // –ê–≤—Ç–æ–ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –∞–∫—Ü–∏–∏
    document.querySelectorAll('input[name="promotion_id"]').forEach(function(el){
        el.addEventListener('change', function(){
            try { localStorage.setItem('checkout_promotion_id', this.value || ''); } catch(e) {}
            this.closest('form').submit();
        });
    });
});
</script>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ YooMoney -->
<div class="modal fade" id="yoomoneyModal" tabindex="-1" aria-labelledby="yoomoneyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #4f46e5, #7c3aed); color: white;">
                <h5 class="modal-title" id="yoomoneyModalLabel">
                    <i class="fas fa-credit-card me-2"></i>YooMoney - –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–ø–ª–∞—Ç–∞
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –æ–ø–ª–∞—Ç—ã -->
                <div class="payment-progress mb-4">
                    <div class="progress-steps d-flex justify-content-between">
                        <div class="step active" id="step-card">
                            <div class="step-icon"><i class="fas fa-credit-card"></i></div>
                            <div class="step-label">–î–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã</div>
                        </div>
                        <div class="step" id="step-3d">
                            <div class="step-icon"><i class="fas fa-shield-alt"></i></div>
                            <div class="step-label">3D Secure</div>
                        </div>
                        <div class="step" id="step-success">
                            <div class="step-icon"><i class="fas fa-check"></i></div>
                            <div class="step-label">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</div>
                        </div>
                    </div>
                </div>

                <!-- –§–æ—Ä–º–∞ –∫–∞—Ä—Ç—ã -->
                <div id="card-form">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="payment-form">
                                <div class="mb-3">
                                    <label for="modal_card_number" class="form-label">
                                        <i class="fas fa-credit-card me-1"></i>–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã
                                    </label>
                                    <input type="text" class="form-control" id="modal_card_number" placeholder="1234 5678 9012 3456" maxlength="19">
                                    <div class="card-icons mt-2">
                                        <i class="fab fa-cc-visa text-primary me-2"></i>
                                        <i class="fab fa-cc-mastercard text-warning me-2"></i>
                                        <i class="fas fa-credit-card text-success"></i>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="modal_card_expiry" class="form-label">–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è</label>
                                        <input type="text" class="form-control" id="modal_card_expiry" placeholder="MM/YY" maxlength="5">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="modal_card_cvv" class="form-label">CVV</label>
                                        <input type="text" class="form-control" id="modal_card_cvv" placeholder="123" maxlength="3">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="modal_card_holder" class="form-label">–ò–º—è –≤–ª–∞–¥–µ–ª—å—Ü–∞</label>
                                    <input type="text" class="form-control" id="modal_card_holder" placeholder="IVAN IVANOV">
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="modal_save_card">
                                    <label class="form-check-label" for="modal_save_card">
                                        <i class="fas fa-save me-1"></i>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞—Ä—Ç—É –¥–ª—è –±—É–¥—É—â–∏—Ö –ø–æ–∫—É–ø–æ–∫
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="payment-info">
                                <h6 class="text-primary mb-3">
                                    <i class="fas fa-receipt me-2"></i>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–ª–∞—Ç–µ–∂–µ
                                </h6>
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>–°—É–º–º–∞:</span>
                                            <span id="modal_amount">0 ‚ÇΩ</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>–ö–æ–º–∏—Å—Å–∏—è:</span>
                                            <span class="text-success">0 ‚ÇΩ</span>
                                        </div>
                                        <hr>
                                        <div class="d-flex justify-content-between">
                                            <strong>–ö –æ–ø–ª–∞—Ç–µ:</strong>
                                            <strong id="modal_total">0 ‚ÇΩ</strong>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <h6 class="text-success">
                                        <i class="fas fa-shield-alt me-2"></i>–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
                                    </h6>
                                    <ul class="list-unstyled small">
                                        <li><i class="fas fa-lock text-success me-2"></i>SSL —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ</li>
                                        <li><i class="fas fa-shield-alt text-success me-2"></i>3D Secure</li>
                                        <li><i class="fas fa-check-circle text-success me-2"></i>PCI DSS</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3D Secure —Ñ–æ—Ä–º–∞ -->
                <div id="3d-secure-form" style="display: none;">
                    <div class="text-center">
                        <div class="mb-4">
                            <i class="fas fa-shield-alt fa-3x text-primary"></i>
                        </div>
                        <h5>3D Secure –ø—Ä–æ–≤–µ—Ä–∫–∞</h5>
                        <p class="text-muted">–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–∑ SMS –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞</p>
                        <div class="row justify-content-center">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="sms_code" class="form-label">SMS –∫–æ–¥</label>
                                    <input type="text" class="form-control text-center" id="sms_code" placeholder="123456" maxlength="6">
                                </div>
                                <div class="mb-3">
                                    <button type="button" class="btn btn-outline-primary btn-sm" id="resend-sms">
                                        <i class="fas fa-redo me-1"></i>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –£—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞ -->
                <div id="payment-success" style="display: none;">
                    <div class="text-center">
                        <div class="mb-4">
                            <i class="fas fa-check-circle fa-3x text-success"></i>
                        </div>
                        <h5 class="text-success">–ü–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω!</h5>
                        <p class="text-muted">–í–∞—à –∑–∞–∫–∞–∑ –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è</p>
                        <div class="alert alert-success">
                            <strong>–ù–æ–º–µ—Ä —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:</strong> <span id="transaction-id"></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="cancel-btn">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" id="processPaymentBtn">
                    <i class="fas fa-credit-card me-2"></i>–û–ø–ª–∞—Ç–∏—Ç—å
                </button>
                <button type="button" class="btn btn-success" id="confirm3dBtn" style="display: none;">
                    <i class="fas fa-shield-alt me-2"></i>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// –û–±–Ω–æ–≤–ª—è–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –æ–Ω–ª–∞–π–Ω –æ–ø–ª–∞—Ç—ã
document.addEventListener('DOMContentLoaded', function() {
    const onlinePaymentRadio = document.getElementById('online');
    const yoomoneyModal = new bootstrap.Modal(document.getElementById('yoomoneyModal'));
    
    onlinePaymentRadio.addEventListener('change', function() {
        if (this.checked) {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É–º–º—É –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
            const currentTotal = updateTotalAmount();
            document.getElementById('modal_amount').textContent = currentTotal + ' ‚ÇΩ';
            document.getElementById('modal_total').textContent = currentTotal + ' ‚ÇΩ';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            yoomoneyModal.show();
        }
    });
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–ø–ª–∞—Ç—ã –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
    document.getElementById('processPaymentBtn').addEventListener('click', function() {
        const cardNumber = document.getElementById('modal_card_number').value;
        const cardExpiry = document.getElementById('modal_card_expiry').value;
        const cardCvv = document.getElementById('modal_card_cvv').value;
        const cardHolder = document.getElementById('modal_card_holder').value;
        
        if (!cardNumber || !cardExpiry || !cardCvv || !cardHolder) {
            showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∫–∞—Ä—Ç—ã', 'error');
            return;
        }
        
        // –°–∏–º—É–ª—è—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–∞
        simulatePaymentProcess();
    });
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ 3D Secure
    document.getElementById('confirm3dBtn').addEventListener('click', function() {
        const smsCode = document.getElementById('sms_code').value;
        
        if (!smsCode || smsCode.length !== 6) {
            showToast('–í–≤–µ–¥–∏—Ç–µ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ –∏–∑ SMS', 'error');
            return;
        }
        
        // –°–∏–º—É–ª—è—Ü–∏—è —É—Å–ø–µ—à–Ω–æ–π 3D Secure –ø—Ä–æ–≤–µ—Ä–∫–∏
        setTimeout(() => {
            showPaymentSuccess();
        }, 1000);
    });
    
    // –§—É–Ω–∫—Ü–∏—è —Å–∏–º—É–ª—è—Ü–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ –æ–ø–ª–∞—Ç—ã
    function simulatePaymentProcess() {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º 3D Secure —Ñ–æ—Ä–º—É
        document.getElementById('card-form').style.display = 'none';
        document.getElementById('3d-secure-form').style.display = 'block';
        document.getElementById('processPaymentBtn').style.display = 'none';
        document.getElementById('confirm3dBtn').style.display = 'inline-block';
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
        document.getElementById('step-card').classList.remove('active');
        document.getElementById('step-card').classList.add('completed');
        document.getElementById('step-3d').classList.add('active');
        
        // –°–∏–º—É–ª–∏—Ä—É–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É SMS
        showToast('SMS –∫–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –≤–∞—à —Ç–µ–ª–µ—Ñ–æ–Ω', 'info');
        
        // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ SMS –∫–æ–¥–∞ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
        setTimeout(() => {
            document.getElementById('sms_code').value = '123456';
        }, 2000);
    }
    
    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã
    function showPaymentSuccess() {
        document.getElementById('3d-secure-form').style.display = 'none';
        document.getElementById('payment-success').style.display = 'block';
        document.getElementById('confirm3dBtn').style.display = 'none';
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
        document.getElementById('step-3d').classList.remove('active');
        document.getElementById('step-3d').classList.add('completed');
        document.getElementById('step-success').classList.add('active');
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–º–µ—Ä —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
        const transactionId = 'TXN_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        document.getElementById('transaction-id').textContent = transactionId;
        
        // –ö–æ–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –æ—Å–Ω–æ–≤–Ω—É—é —Ñ–æ—Ä–º—É
        document.getElementById('card_number').value = document.getElementById('modal_card_number').value;
        document.getElementById('card_expiry').value = document.getElementById('modal_card_expiry').value;
        document.getElementById('card_cvv').value = document.getElementById('modal_card_cvv').value;
        document.getElementById('card_holder').value = document.getElementById('modal_card_holder').value;
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
            yoomoneyModal.hide();
            document.querySelector('form').submit();
        }, 3000);
    }
    
    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} border-0`;
        toast.setAttribute('role', 'alert');
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;
        
        let toastContainer = document.getElementById('toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toast-container';
            toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
            toastContainer.style.zIndex = '9999';
            document.body.appendChild(toastContainer);
        }
        
        toastContainer.appendChild(toast);
        
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
        
        toast.addEventListener('hidden.bs.toast', () => {
            toast.remove();
        });
    }
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ –∫–∞—Ä—Ç—ã –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
    document.getElementById('modal_card_number').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
        let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
        e.target.value = formattedValue;
    });
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
    document.getElementById('modal_card_expiry').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length >= 2) {
            value = value.substring(0, 2) + '/' + value.substring(2, 4);
        }
        e.target.value = value;
    });
});
</script>
{% if promo_message %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const promoHtml = `
        <div class="modal fade" id="promoModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">–ê–∫—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">{{ promo_message|escapejs }}</div>
              <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">–ü–æ–Ω—è—Ç–Ω–æ</button>
              </div>
            </div>
          </div>
        </div>`;
    document.body.insertAdjacentHTML('beforeend', promoHtml);
    new bootstrap.Modal(document.getElementById('promoModal')).show();
});
</script>
{% endif %}
{% endblock %}

