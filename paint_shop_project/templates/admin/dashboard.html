{% extends "admin/base_site.html" %}
{% load i18n %}

{% block title %}{{ title }} | {% trans "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ Django" %}{% endblock %}

{% block extrastyle %}
<style>
    .dashboard-container { 
        padding: 20px; 
        max-width: 100%;
    }
    .dashboard-header { 
        display: flex; 
        flex-wrap: wrap; 
        gap: 18px; 
        align-items: center; 
        justify-content: space-between; 
        margin-bottom: 32px; 
        padding-bottom: 20px;
        border-bottom: 1px solid #e0e0e0;
    }
    .dashboard-stats { 
        display: grid; 
        gap: 20px; 
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); 
        margin-bottom: 32px; 
    }
    .stat-card { 
        background: var(--card-bg, #fff); 
        border-radius: 12px; 
        padding: 24px; 
        box-shadow: 0 4px 12px rgba(0,0,0,0.05); 
        color: var(--text-color, #1a2a6c); 
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        border: 1px solid #e0e0e0;
    }
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }
    .stat-card .label { 
        font-size: 14px; 
        text-transform: uppercase; 
        color: var(--text-color, #6c757d); 
        letter-spacing: 0.08em; 
        margin-bottom: 8px; 
        font-weight: 600;
    }
    .stat-card .value { 
        font-size: 36px; 
        font-weight: 700; 
        color: var(--text-color, #1a2a6c); 
        margin-bottom: 4px; 
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .stat-card .change { 
        font-size: 14px; 
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .stat-card .change.positive { 
        color: #10b981; 
    }
    .stat-card .change.negative { 
        color: #ef4444; 
    }
    .dashboard-charts { 
        display: grid; 
        gap: 24px; 
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); 
        margin-bottom: 32px; 
    }
    .chart-card { 
        background: var(--card-bg, #fff); 
        border-radius: 12px; 
        padding: 24px; 
        box-shadow: 0 4px 12px rgba(0,0,0,0.05); 
        color: var(--text-color, #1a2a6c); 
        border: 1px solid #e0e0e0;
    }
    .chart-card h3 { 
        margin-top: 0; 
        margin-bottom: 20px; 
        color: var(--text-color, #1a2a6c); 
        font-size: 20px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .chart-container { 
        position: relative; 
        height: 350px; 
        width: 100%;
    }
    .dashboard-actions { 
        display: flex; 
        gap: 12px; 
        flex-wrap: wrap; 
        margin-bottom: 24px; 
    }
    .period-selector { 
        display: flex; 
        gap: 8px; 
        margin-bottom: 24px;
        flex-wrap: wrap;
    }
    .period-selector button { 
        padding: 10px 20px; 
        border: 1px solid var(--border-color, #d0d7de); 
        background: var(--input-bg, #fff); 
        border-radius: 8px; 
        cursor: pointer; 
        color: var(--text-color, #1a2a6c); 
        font-weight: 500;
        transition: all 0.2s ease;
    }
    .period-selector button:hover {
        background: #f5f5f5;
    }
    .period-selector button.active { 
        background: var(--primary-color, #1a2a6c); 
        color: #fff; 
        border-color: var(--primary-color, #1a2a6c); 
    }
    .alert {
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 20px;
    }
    .alert-danger {
        background-color: #fee2e2;
        border: 1px solid #fecaca;
        color: #991b1b;
    }
    .btn-close {
        float: right;
        background: none;
        border: none;
        font-size: 20px;
        cursor: pointer;
    }
    .table-container {
        overflow-x: auto;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }
    th, td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #e0e0e0;
    }
    th {
        background-color: #f8f9fa;
        font-weight: 600;
        color: #495057;
    }
    tr:hover {
        background-color: #f8f9fa;
    }
    .chart-icon {
        font-size: 24px;
    }
    /* Chart.js specific styles */
    canvas {
        display: block;
        width: 100% !important;
        height: 100% !important;
    }
</style>
<!-- Load Chart.js and plugins -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0/dist/chartjs-plugin-datalabels.min.js"></script>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div id="dashboard-alerts"></div>
    <div class="dashboard-header">
        <div>
            <h1>{{ title }}</h1>
            <p class="help">{% trans "–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø—Ä–æ–¥–∞–∂ –∏ –∫–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –º–∞–≥–∞–∑–∏–Ω–∞" %}</p>
        </div>
        <div class="dashboard-actions">
            <a href="{% url 'admin:index' %}" class="button">{% trans "‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è" %}</a>
            <a href="{% url 'admin:export-reports' %}" class="button default">{% trans "üìä –≠–∫—Å–ø–æ—Ä—Ç –æ—Ç—á–µ—Ç–æ–≤" %}</a>
        </div>
    </div>

    <div class="dashboard-stats">
        <div class="stat-card">
            <div class="label">{% trans "–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞" %}</div>
            <div class="value">{{ total_revenue|floatformat:2 }} ‚ÇΩ</div>
            <div class="change positive">+ {{ revenue_last_30|floatformat:2 }} ‚ÇΩ {% trans "–∑–∞ 30 –¥–Ω–µ–π" %}</div>
        </div>
        <div class="stat-card">
            <div class="label">{% trans "–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤" %}</div>
            <div class="value">{{ orders_total }}</div>
            <div class="change positive">+ {{ orders_last_30 }} {% trans "–∑–∞ 30 –¥–Ω–µ–π" %}</div>
        </div>
        <div class="stat-card">
            <div class="label">{% trans "–°—Ä–µ–¥–Ω–∏–π —á–µ–∫" %}</div>
            <div class="value">{{ avg_order_value|floatformat:2 }} ‚ÇΩ</div>
            <div class="change">{% trans "–ü–æ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–º –∑–∞–∫–∞–∑–∞–º" %}</div>
        </div>
        <div class="stat-card">
            <div class="label">{% trans "–ö–ª–∏–µ–Ω—Ç—ã" %}</div>
            <div class="value">{{ total_customers }}</div>
            <div class="change positive">+ {{ new_customers_30 }} {% trans "–Ω–æ–≤—ã—Ö –∑–∞ 30 –¥–Ω–µ–π" %}</div>
        </div>
    </div>

    <div class="period-selector">
        <button class="active" data-period="7">{% trans "7 –¥–Ω–µ–π" %}</button>
        <button data-period="30">{% trans "30 –¥–Ω–µ–π" %}</button>
        <button data-period="90">{% trans "90 –¥–Ω–µ–π" %}</button>
        <button data-period="365">{% trans "–ì–æ–¥" %}</button>
    </div>

    <div class="dashboard-charts">
        <div class="chart-card">
            <h3>üìà {% trans "–í—ã—Ä—É—á–∫–∞ –ø–æ –¥–Ω—è–º" %}</h3>
            <div class="chart-container">
                <canvas id="revenueChart"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <h3>üì¶ {% trans "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤" %}</h3>
            <div class="chart-container">
                <canvas id="ordersChart"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <h3>üìä {% trans "–°—Ç–∞—Ç—É—Å—ã –∑–∞–∫–∞–∑–æ–≤" %}</h3>
            <div class="chart-container">
                <canvas id="statusChart"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <h3>üèÜ {% trans "–¢–æ–ø-10 —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –≤—ã—Ä—É—á–∫–µ" %}</h3>
            <div class="chart-container">
                <canvas id="productsChart"></canvas>
            </div>
        </div>
    </div>

    {% if top_products %}
    <div class="chart-card">
        <h3>üìã {% trans "–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è —Ç–æ–ø-—Ç–æ–≤–∞—Ä–æ–≤" %}</h3>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>{% trans "–¢–æ–≤–∞—Ä" %}</th>
                        <th style="text-align: right;">{% trans "–í—ã—Ä—É—á–∫–∞" %}</th>
                        <th style="text-align: right;">{% trans "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ" %}</th>
                        <th style="text-align: right;">{% trans "–ó–∞–∫–∞–∑–æ–≤" %}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for product in top_products %}
                    <tr>
                        <td>{{ product.product__name|default:"‚Äî" }}</td>
                        <td style="text-align: right;">{{ product.revenue|floatformat:2 }} ‚ÇΩ</td>
                        <td style="text-align: right;">{{ product.quantity }}</td>
                        <td style="text-align: right;">{{ product.orders }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>

{{ daily_data|json_script:"dashboard-daily-data" }}
{{ orders_by_status|json_script:"dashboard-orders-by-status" }}
{{ top_products|json_script:"dashboard-top-products" }}

<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentPeriod = 30;
    let revenueChart, ordersChart, statusChart, productsChart;
    const alertsContainer = document.getElementById('dashboard-alerts');
    const initialDailyDataElement = document.getElementById('dashboard-daily-data');
    const initialDailyData = initialDailyDataElement ? JSON.parse(initialDailyDataElement.textContent) : [];
    
    // Parse status data
    const ordersByStatusElement = document.getElementById('dashboard-orders-by-status');
    const ordersByStatus = ordersByStatusElement ? JSON.parse(ordersByStatusElement.textContent) : [];
    
    // Parse top products data
    const topProductsElement = document.getElementById('dashboard-top-products');
    const topProducts = topProductsElement ? JSON.parse(topProductsElement.textContent) : [];

    // Register the plugin
    if (typeof Chart !== 'undefined' && typeof ChartDataLabels !== 'undefined') {
        Chart.register(ChartDataLabels);
        console.log('[DASHBOARD] Chart.js and plugins loaded successfully');
    } else {
        console.error('[DASHBOARD] Chart.js or plugins not loaded properly');
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
    function initCharts() {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Chart.js
        if (typeof Chart === 'undefined') {
            console.error('[CHART] Chart.js –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω! –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏...');
            setTimeout(initCharts, 500);
            return;
        }
        
        const ctxRevenue = document.getElementById('revenueChart');
        const ctxOrders = document.getElementById('ordersChart');
        const ctxStatus = document.getElementById('statusChart');
        const ctxProducts = document.getElementById('productsChart');

        if (!ctxRevenue || !ctxOrders || !ctxStatus || !ctxProducts) {
            console.error('[CHART] Canvas elements not found!', {
                revenue: !!ctxRevenue,
                orders: !!ctxOrders,
                status: !!ctxStatus,
                products: !!ctxProducts
            });
            return;
        }

        console.log('[CHART] Initializing revenue chart...');
        // Destroy existing chart if it exists
        if (revenueChart) {
            revenueChart.destroy();
        }
        revenueChart = new Chart(ctxRevenue, {
            type: 'line',
            data: { 
                labels: [], 
                datasets: [{
                    label: '–í—ã—Ä—É—á–∫–∞',
                    data: [],
                    borderColor: '#1a2a6c',
                    backgroundColor: 'rgba(26, 42, 108, 0.1)',
                    tension: 0.4,
                    borderWidth: 3,
                    pointRadius: 4,
                    pointBackgroundColor: '#1a2a6c',
                    pointBorderColor: '#fff',
                    pointHoverRadius: 6,
                    pointHoverBackgroundColor: '#1a2a6c',
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { 
                        display: true, 
                        position: 'top',
                        labels: {
                            font: {
                                size: 14
                            }
                        }
                    },
                    tooltip: { 
                        enabled: true,
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleFont: {
                            size: 14
                        },
                        bodyFont: {
                            size: 13
                        },
                        padding: 12,
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y.toLocaleString('ru-RU') + ' ‚ÇΩ';
                            }
                        }
                    }
                },
                scales: {
                    y: { 
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        ticks: { 
                            callback: function(value) { 
                                return value.toLocaleString('ru-RU') + ' ‚ÇΩ'; 
                            },
                            font: {
                                size: 12
                            }
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        ticks: {
                            font: {
                                size: 12
                            }
                        }
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                }
            }
        });
        console.log('[CHART] Revenue chart initialized:', revenueChart ? 'OK' : 'FAILED');

        console.log('[CHART] Initializing orders chart...');
        // Destroy existing chart if it exists
        if (ordersChart) {
            ordersChart.destroy();
        }
        ordersChart = new Chart(ctxOrders, {
            type: 'bar',
            data: { 
                labels: [], 
                datasets: [{
                    label: '–ó–∞–∫–∞–∑—ã',
                    data: [],
                    backgroundColor: '#4f63d8',
                    borderColor: '#1a2a6c',
                    borderWidth: 1,
                    borderRadius: 6,
                    borderSkipped: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { 
                        enabled: true,
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleFont: {
                            size: 14
                        },
                        bodyFont: {
                            size: 13
                        },
                        padding: 12
                    }
                },
                scales: {
                    y: { 
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        ticks: {
                            font: {
                                size: 12
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            font: {
                                size: 12
                            }
                        }
                    }
                }
            }
        });
        console.log('[CHART] Orders chart initialized:', ordersChart ? 'OK' : 'FAILED');

        // Destroy existing chart if it exists
        if (statusChart) {
            statusChart.destroy();
        }
        statusChart = new Chart(ctxStatus, {
            type: 'doughnut',
            data: { 
                labels: [], 
                datasets: [{
                    data: [],
                    backgroundColor: [
                        '#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'
                    ],
                    borderColor: '#fff',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { 
                        position: 'bottom',
                        labels: {
                            font: {
                                size: 13
                            },
                            padding: 15
                        }
                    },
                    tooltip: { 
                        enabled: true,
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleFont: {
                            size: 14
                        },
                        bodyFont: {
                            size: 13
                        },
                        padding: 12
                    }
                },
                cutout: '60%'
            }
        });

        // Destroy existing chart if it exists
        if (productsChart) {
            productsChart.destroy();
        }
        productsChart = new Chart(ctxProducts, {
            type: 'bar',
            data: { 
                labels: [], 
                datasets: [{
                    label: '–í—ã—Ä—É—á–∫–∞',
                    data: [],
                    backgroundColor: [
                        '#1a2a6c', '#2d378c', '#3e46ac', '#4f63d8', '#6070e8',
                        '#7180f8', '#8290ff', '#93a0ff', '#a4b0ff', '#b5c0ff'
                    ],
                    borderColor: '#1a2a6c',
                    borderWidth: 1,
                    borderRadius: 4,
                    borderSkipped: false
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { 
                        enabled: true,
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleFont: {
                            size: 14
                        },
                        bodyFont: {
                            size: 13
                        },
                        padding: 12,
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.x.toLocaleString('ru-RU') + ' ‚ÇΩ';
                            }
                        }
                    }
                },
                scales: {
                    x: { 
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        ticks: {
                            font: {
                                size: 12
                            },
                            callback: function(value) {
                                return value.toLocaleString('ru-RU') + ' ‚ÇΩ';
                            }
                        }
                    },
                    y: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            font: {
                                size: 12
                            }
                        }
                    }
                }
            }
        });

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –≥—Ä–∞—Ñ–∏–∫–∏ —Å—Ä–∞–∑—É
        updateStatusChart();
        updateProductsChart();
        
        if (initialDailyData.length) {
            updateRevenueChart(initialDailyData);
            updateOrdersChart(initialDailyData);
        } else {
            loadData(currentPeriod);
        }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    function loadData(period) {
        console.log('[DASHBOARD] Loading data for period:', period);
        const startTime = performance.now();
        
        fetch('/admin/dashboard/api/?period=' + period, { credentials: 'same-origin' })
            .then(response => {
                console.log('[DASHBOARD] Response status:', response.status, response.statusText);
                if (!response.ok) {
                    throw new Error('HTTP error! status: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                const loadTime = performance.now() - startTime;
                console.log('[DASHBOARD] Data loaded in', loadTime.toFixed(2), 'ms');
                console.log('[DASHBOARD] Data structure:', {
                    daily_count: data.daily ? data.daily.length : 0,
                    monthly_count: data.monthly ? data.monthly.length : 0,
                    period: data.period
                });
                
                if (data.daily && data.daily.length > 0) {
                    console.log('[DASHBOARD] First daily item:', data.daily[0]);
                    console.log('[DASHBOARD] Last daily item:', data.daily[data.daily.length - 1]);
                    updateRevenueChart(data.daily);
                    updateOrdersChart(data.daily);
                    console.log('[DASHBOARD] Charts updated successfully');
                } else {
                    console.warn('[DASHBOARD] No daily data available, data object:', data);
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏ —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º
                    updateRevenueChart([]);
                    updateOrdersChart([]);
                }
            })
            .catch(error => {
                const loadTime = performance.now() - startTime;
                console.error('[DASHBOARD] Error loading data after', loadTime.toFixed(2), 'ms:', error);
                console.error('[DASHBOARD] Error stack:', error.stack);
                showDashboardError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
            });
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ –≤—ã—Ä—É—á–∫–∏
    function updateRevenueChart(data) {
        console.log('[CHART] updateRevenueChart called with', data ? data.length : 0, 'items');
        if (!revenueChart) {
            console.error('[CHART] revenueChart is not initialized!');
            return;
        }
        if (!data || data.length === 0) {
            console.warn('[CHART] Empty data for revenue chart');
            revenueChart.data.labels = [];
            revenueChart.data.datasets[0].data = [];
            revenueChart.update();
            return;
        }
        const labels = data.map(d => d.day);
        const revenues = data.map(d => parseFloat(d.revenue || 0));
        console.log('[CHART] Revenue chart labels count:', labels.length);
        console.log('[CHART] Revenue chart data sample:', revenues.slice(0, 5));
        revenueChart.data.labels = labels;
        revenueChart.data.datasets[0].data = revenues;
        revenueChart.update();
        console.log('[CHART] Revenue chart updated');
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ –∑–∞–∫–∞–∑–æ–≤
    function updateOrdersChart(data) {
        console.log('[CHART] updateOrdersChart called with', data ? data.length : 0, 'items');
        if (!ordersChart) {
            console.error('[CHART] ordersChart is not initialized!');
            return;
        }
        if (!data || data.length === 0) {
            console.warn('[CHART] Empty data for orders chart');
            ordersChart.data.labels = [];
            ordersChart.data.datasets[0].data = [];
            ordersChart.update();
            return;
        }
        const labels = data.map(d => d.day);
        const orders = data.map(d => parseInt(d.orders || 0));
        console.log('[CHART] Orders chart labels count:', labels.length);
        console.log('[CHART] Orders chart data sample:', orders.slice(0, 5));
        ordersChart.data.labels = labels;
        ordersChart.data.datasets[0].data = orders;
        ordersChart.update('active');
        console.log('[CHART] Orders chart updated');
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤
    function updateStatusChart() {
        const statusLabels = {
            'created': '–°–æ–∑–¥–∞–Ω',
            'confirmed': '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω',
            'ready': '–ì–æ—Ç–æ–≤',
            'in_transit': '–í –ø—É—Ç–∏',
            'delivered': '–î–æ—Å—Ç–∞–≤–ª–µ–Ω',
            'cancelled': '–û—Ç–º–µ–Ω—ë–Ω'
        };

        if (ordersByStatus.length > 0 && statusChart) {
            const labels = ordersByStatus.map(s => statusLabels[s.status] || s.status);
            const data = ordersByStatus.map(s => s.count);
            statusChart.data.labels = labels;
            statusChart.data.datasets[0].data = data;
            statusChart.update();
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
    function updateProductsChart() {
        if (topProducts.length > 0 && productsChart) {
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É –Ω–∞–∑–≤–∞–Ω–∏–π —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –ª—É—á—à–µ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            const labels = topProducts.slice(0, 10).map(p => {
                const name = p.product__name || '‚Äî';
                return name.length > 20 ? name.substring(0, 17) + '...' : name;
            });
            const revenues = topProducts.slice(0, 10).map(p => parseFloat(p.revenue || 0));
            productsChart.data.labels = labels;
            productsChart.data.datasets[0].data = revenues;
            productsChart.update();
        }
    }

    function showDashboardError(message) {
        if (!alertsContainer) return;
        alertsContainer.innerHTML = `
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert">√ó</button>
            </div>
        `;
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≥—Ä–∞—Ñ–∏–∫–∏
    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏ Chart.js
    setTimeout(initCharts, 100);

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–µ—Ä–∏–æ–¥–∞
    document.querySelectorAll('.period-selector button').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.period-selector button').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentPeriod = parseInt(this.dataset.period);
            loadData(currentPeriod);
        });
    });

});
</script>
{% endblock %}