{% extends "admin/base_site.html" %}
{% load i18n %}

{% block title %}{{ title }} | {% trans "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ Django" %}{% endblock %}

{% block extrastyle %}
<style>
    .warehouse-dashboard { padding-bottom: 40px; }
    .dashboard-header { 
        display: flex; 
        flex-wrap: wrap; 
        gap: 18px; 
        align-items: center; 
        justify-content: space-between; 
        margin-bottom: 32px; 
    }
    .dashboard-stats { 
        display: grid; 
        gap: 18px; 
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); 
        margin-bottom: 32px; 
    }
    .stat-card { 
        background: #fff; 
        border-radius: 12px; 
        padding: 20px; 
        box-shadow: 0 12px 30px rgba(0,0,0,0.05); 
        border-left: 4px solid #1a2a6c;
    }
    .stat-card.warning { border-left-color: #f59e0b; }
    .stat-card.danger { border-left-color: #ef4444; }
    .stat-card.success { border-left-color: #10b981; }
    .stat-card .label { 
        font-size: 12px; 
        text-transform: uppercase; 
        color: #6c757d; 
        letter-spacing: .08em; 
        margin-bottom: 8px; 
    }
    .stat-card .value { 
        font-size: 32px; 
        font-weight: 700; 
        color: #1a2a6c; 
        margin-bottom: 4px; 
    }
    .stat-card .subvalue { 
        font-size: 14px; 
        color: #6c757d; 
    }
    .dashboard-charts { 
        display: grid; 
        gap: 24px; 
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); 
        margin-bottom: 32px; 
    }
    .chart-card { 
        background: #fff; 
        border-radius: 12px; 
        padding: 24px; 
        box-shadow: 0 12px 30px rgba(0,0,0,0.05); 
    }
    .chart-card h3 { margin-top: 0; margin-bottom: 20px; }
    .chart-container { position: relative; height: 300px; }
    .period-selector { 
        display: flex; 
        gap: 8px; 
        margin-bottom: 24px;
    }
    .period-selector button { 
        padding: 8px 16px; 
        border: 1px solid #d0d7de; 
        background: #fff; 
        border-radius: 6px; 
        cursor: pointer; 
    }
    .period-selector button.active { 
        background: #1a2a6c; 
        color: #fff; 
        border-color: #1a2a6c; 
    }
    .category-heatmap { 
        display: grid; 
        gap: 12px; 
        margin-top: 20px;
    }
    .category-item { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        padding: 12px; 
        background: #f8f9fa; 
        border-radius: 6px; 
    }
    .category-item .name { font-weight: 600; }
    .category-item .badge { 
        padding: 4px 12px; 
        border-radius: 12px; 
        font-size: 12px; 
        font-weight: 600;
    }
    .badge.danger { background: #fee2e2; color: #991b1b; }
    .badge.warning { background: #fef3c7; color: #92400e; }
    .badge.success { background: #d1fae5; color: #065f46; }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}
<div class="warehouse-dashboard">
    <div class="dashboard-header">
        <div>
            <h1>{{ title }}</h1>
            <p class="help">{% trans "–ú–µ—Ç—Ä–∏–∫–∏ –ø–æ –ø–∞—Ä—Ç–∏—è–º —Ç–æ–≤–∞—Ä–æ–≤, —Å—Ä–æ–∫–∞–º –≥–æ–¥–Ω–æ—Å—Ç–∏ –∏ –æ—Å—Ç–∞—Ç–∫–∞–º" %}</p>
        </div>
        <div>
            <a href="{% url 'admin:index' %}" class="button">‚Üê {% trans "–í–µ—Ä–Ω—É—Ç—å—Å—è" %}</a>
            <a href="{% url 'admin:export-reports' %}" class="button default">{% trans "üìä –≠–∫—Å–ø–æ—Ä—Ç –æ—Ç—á–µ—Ç–æ–≤" %}</a>
        </div>
    </div>

    <div class="dashboard-stats">
        <div class="stat-card warning">
            <div class="label">‚ö†Ô∏è {% trans "–ò—Å—Ç–µ–∫–∞—é—Ç —á–µ—Ä–µ–∑ 3 –¥–Ω—è" %}</div>
            <div class="value">{{ expiring_3_days }}</div>
            <div class="subvalue">{% trans "–ø–∞—Ä—Ç–∏–π —Ç—Ä–µ–±—É—é—Ç –≤–Ω–∏–º–∞–Ω–∏—è" %}</div>
        </div>
        <div class="stat-card">
            <div class="label">üü° {% trans "–ò—Å—Ç–µ–∫–∞—é—Ç —á–µ—Ä–µ–∑ 7 –¥–Ω–µ–π" %}</div>
            <div class="value">{{ expiring_7_days }}</div>
            <div class="subvalue">{% trans "–ø–∞—Ä—Ç–∏–π" %}</div>
        </div>
        <div class="stat-card">
            <div class="label">üìÖ {% trans "–ò—Å—Ç–µ–∫–∞—é—Ç —á–µ—Ä–µ–∑ 14 –¥–Ω–µ–π" %}</div>
            <div class="value">{{ expiring_14_days }}</div>
            <div class="subvalue">{% trans "–ø–∞—Ä—Ç–∏–π" %}</div>
        </div>
        <div class="stat-card danger">
            <div class="label">‚ùå {% trans "–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ" %}</div>
            <div class="value">{{ expired_count }}</div>
            <div class="subvalue">{{ expired_quantity }} {% trans "–µ–¥–∏–Ω–∏—Ü" %}</div>
        </div>
        <div class="stat-card warning">
            <div class="label">üì¶ {% trans "–ù–∏–∑–∫–∏–π –æ—Å—Ç–∞—Ç–æ–∫" %}</div>
            <div class="value">{{ low_stock_count }}</div>
            <div class="subvalue">{{ low_stock_quantity }} {% trans "–µ–¥–∏–Ω–∏—Ü (‚â§10)" %}</div>
        </div>
        <div class="stat-card">
            <div class="label">üìä {% trans "–í—Å–µ–≥–æ –ø–∞—Ä—Ç–∏–π" %}</div>
            <div class="value">{{ total_batches }}</div>
            <div class="subvalue">{{ total_quantity }} {% trans "–µ–¥–∏–Ω–∏—Ü –Ω–∞ —Å–∫–ª–∞–¥–µ" %}</div>
        </div>
        <div class="stat-card">
            <div class="label">üìâ {% trans "–°–ø–∏—Å–∞–Ω–æ –∑–∞ 30 –¥–Ω–µ–π" %}</div>
            <div class="value">{{ spoiled_count }}</div>
            <div class="subvalue">~{{ spoiled_value|floatformat:2 }} ‚ÇΩ</div>
        </div>
        <div class="stat-card success">
            <div class="label">‚úÖ {% trans "–°—Ä–µ–¥–Ω–∏–π % —Å—Ä–æ–∫–∞" %}</div>
            <div class="value">{{ avg_percent|floatformat:0 }}%</div>
            <div class="subvalue">{% trans "–æ—Å—Ç–∞–ª–æ—Å—å —É –ø–∞—Ä—Ç–∏–π" %}</div>
        </div>
    </div>

    <div class="period-selector">
        <button class="active" data-period="7">{% trans "7 –¥–Ω–µ–π" %}</button>
        <button data-period="30">{% trans "30 –¥–Ω–µ–π" %}</button>
        <button data-period="90">{% trans "90 –¥–Ω–µ–π" %}</button>
    </div>

    <div class="dashboard-charts">
        <div class="chart-card">
            <h3>{% trans "–°–ø–∏—Å–∞–Ω–∏—è –ø–æ –¥–Ω—è–º" %}</h3>
            <div class="chart-container">
                <canvas id="spoiledChart"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <h3>{% trans "–ü–∞—Ä—Ç–∏–∏, –∏—Å—Ç–µ–∫–∞—é—â–∏–µ –ø–æ –¥–Ω—è–º (30 –¥–Ω–µ–π)" %}</h3>
            <div class="chart-container">
                <canvas id="expiringChart"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <h3>{% trans "–û—Å—Ç–∞—Ç–∫–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º" %}</h3>
            <div class="chart-container">
                <canvas id="categoryChart"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <h3>{% trans "–¢–æ–ø —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ —Å–∫–æ—Ä–æ—Å—Ç–∏ –ø—Ä–æ–¥–∞–∂ (7 –¥–Ω–µ–π)" %}</h3>
            <div class="chart-container">
                <canvas id="topProductsChart"></canvas>
            </div>
        </div>
    </div>

    <div class="chart-card">
        <h3>{% trans "–ö–∞—Ä—Ç–∞ —Ç–µ–ø–ª–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º" %}</h3>
        <p class="help">{% trans "–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å –Ω–∞–∏–±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∏—Å—Ç–µ–∫–∞—é—â–∏—Ö –ø–∞—Ä—Ç–∏–π" %}</p>
        <div class="category-heatmap">
            {% for item in batches_by_category %}
            <div class="category-item">
                <span class="name">{{ item.product__category__name|default:"–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏" }}</span>
                <div>
                    <span class="badge {% if item.expiring_soon > 5 %}danger{% elif item.expiring_soon > 2 %}warning{% else %}success{% endif %}">
                        ‚ö†Ô∏è {{ item.expiring_soon }} {% trans "–∏—Å—Ç–µ–∫–∞—é—Ç" %}
                    </span>
                    <span style="margin-left: 12px; color: #6c757d;">
                        {{ item.total_batches }} {% trans "–ø–∞—Ä—Ç–∏–π" %}, {{ item.total_quantity }} {% trans "–µ–¥." %}
                    </span>
                </div>
            </div>
            {% empty %}
            <p>{% trans "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö" %}</p>
            {% endfor %}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const periodButtons = document.querySelectorAll('.period-selector button');
    let currentPeriod = 30;
    
    // –ì—Ä–∞—Ñ–∏–∫ —Å–ø–∏—Å–∞–Ω–∏–π
    const spoiledCtx = document.getElementById('spoiledChart').getContext('2d');
    let spoiledChart = null;
    
    // –ì—Ä–∞—Ñ–∏–∫ –∏—Å—Ç–µ–∫–∞—é—â–∏—Ö –ø–∞—Ä—Ç–∏–π
    const expiringCtx = document.getElementById('expiringChart').getContext('2d');
    let expiringChart = null;
    
    // –ì—Ä–∞—Ñ–∏–∫ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
    const categoryCtx = document.getElementById('categoryChart').getContext('2d');
    const categoryData = {
        labels: [{% for item in batches_by_category %}'{{ item.product__category__name|default:"–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏" }}'{% if not forloop.last %},{% endif %}{% endfor %}],
        datasets: [{
            label: '{% trans "–û—Å—Ç–∞—Ç–æ–∫" %}',
            data: [{% for item in batches_by_category %}{{ item.total_quantity }}{% if not forloop.last %},{% endif %}{% endfor %}],
            backgroundColor: 'rgba(26, 42, 108, 0.6)',
            borderColor: 'rgba(26, 42, 108, 1)',
            borderWidth: 1
        }]
    };
    new Chart(categoryCtx, {
        type: 'bar',
        data: categoryData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
    
    // –ì—Ä–∞—Ñ–∏–∫ —Ç–æ–ø —Ç–æ–≤–∞—Ä–æ–≤
    const topProductsCtx = document.getElementById('topProductsChart').getContext('2d');
    const topProductsData = {
        labels: [{% for item in top_products %}'{{ item.product__name|truncatewords:3 }}'{% if not forloop.last %},{% endif %}{% endfor %}],
        datasets: [{
            label: '{% trans "–ü—Ä–æ–¥–∞–Ω–æ –µ–¥–∏–Ω–∏—Ü" %}',
            data: [{% for item in top_products %}{{ item.total_sold }}{% if not forloop.last %},{% endif %}{% endfor %}],
            backgroundColor: 'rgba(16, 185, 129, 0.6)',
            borderColor: 'rgba(16, 185, 129, 1)',
            borderWidth: 1
        }]
    };
    new Chart(topProductsCtx, {
        type: 'bar',
        data: topProductsData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
    
    function loadChartData(period) {
        fetch(`{% url 'admin:warehouse-dashboard-api' %}?period=${period}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ —Å–ø–∏—Å–∞–Ω–∏–π
                    if (spoiledChart) spoiledChart.destroy();
                    spoiledChart = new Chart(spoiledCtx, {
                        type: 'line',
                        data: {
                            labels: data.spoiled_by_day.map(item => item.day),
                            datasets: [{
                                label: '{% trans "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ø–∏—Å–∞–Ω–∏–π" %}',
                                data: data.spoiled_by_day.map(item => item.count),
                                borderColor: 'rgba(239, 68, 68, 1)',
                                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                tension: 0.4
                            }, {
                                label: '{% trans "–°–ø–∏—Å–∞–Ω–æ –µ–¥–∏–Ω–∏—Ü" %}',
                                data: data.spoiled_by_day.map(item => item.quantity || 0),
                                borderColor: 'rgba(245, 158, 11, 1)',
                                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                                tension: 0.4,
                                yAxisID: 'y1'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: { beginAtZero: true },
                                y1: { 
                                    position: 'right',
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ –∏—Å—Ç–µ–∫–∞—é—â–∏—Ö –ø–∞—Ä—Ç–∏–π
                    if (expiringChart) expiringChart.destroy();
                    expiringChart = new Chart(expiringCtx, {
                        type: 'line',
                        data: {
                            labels: data.expiring_by_day.map(item => item.expiry_date),
                            datasets: [{
                                label: '{% trans "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ä—Ç–∏–π" %}',
                                data: data.expiring_by_day.map(item => item.count),
                                borderColor: 'rgba(245, 158, 11, 1)',
                                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                                tension: 0.4
                            }, {
                                label: '{% trans "–û—Å—Ç–∞—Ç–æ–∫" %}',
                                data: data.expiring_by_day.map(item => item.quantity || 0),
                                borderColor: 'rgba(16, 185, 129, 1)',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                tension: 0.4,
                                yAxisID: 'y1'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: { beginAtZero: true },
                                y1: { 
                                    position: 'right',
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                }
            })
            .catch(error => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error));
    }
    
    periodButtons.forEach(button => {
        button.addEventListener('click', function() {
            periodButtons.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentPeriod = parseInt(this.dataset.period);
            loadChartData(currentPeriod);
        });
    });
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    loadChartData(currentPeriod);
});
</script>
{% endblock %}


