{% extends "admin/base_site.html" %}
{% load i18n %}
{% load admin_filters %}

{% block title %}{{ title }} | {% trans "Администрирование Django" %}{% endblock %}

{% block extrastyle %}
<style>
    .rfm-container { padding-bottom:40px; }
    .rfm-header { display:flex; flex-wrap:wrap; gap:18px; align-items:center; justify-content:space-between; margin-bottom:32px; }
    .rfm-segments { display:grid; gap:24px; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); margin-bottom:32px; }
    .segment-card { background:var(--card-bg, #fff); border-radius:12px; padding:20px; box-shadow:0 12px 30px rgba(0,0,0,0.05); color:var(--text-color, #1a2a6c); }
    .segment-card h3 { margin-top:0; color:var(--text-color, #1a2a6c); }
    .segment-stats { display:flex; gap:16px; margin-bottom:16px; }
    .segment-stat { flex:1; text-align:center; }
    .segment-stat .value { font-size:24px; font-weight:700; color:var(--text-color, #1a2a6c); }
    .segment-stat .label { font-size:12px; color:var(--text-color, #6c757d); }
    .customer-list { max-height:300px; overflow-y:auto; }
    .customer-item { padding:8px; border-bottom:1px solid var(--border-color, #f2f2f2); display:flex; justify-content:space-between; color:var(--text-color, #1a2a6c); }
    .customer-item:last-child { border-bottom:none; }
    .rfm-score { font-family:monospace; font-weight:600; color:var(--text-color, #1a2a6c); }
</style>
{% endblock %}

{% block content %}
<div class="rfm-container">
    <div class="rfm-header">
        <div>
            <h1>{{ title }}</h1>
            <p class="help">{% trans "RFM-анализ: Recency (давность), Frequency (частота), Monetary (деньги)" %}</p>
        </div>
        <a href="{% url 'admin:index' %}" class="button">← {% trans "Вернуться" %}</a>
    </div>

    <div class="rfm-segments">
        {% for segment_name, customers in rfm_segments.items %}
        {% if customers %}
        <div class="segment-card">
            <h3>{{ segment_names|get_item:segment_name|default:segment_name|title }}</h3>
            {% if segment_stats|get_item:segment_name %}
            {% with stats=segment_stats|get_item:segment_name %}
            <div class="segment-stats">
                <div class="segment-stat">
                    <div class="value">{{ stats.count }}</div>
                    <div class="label">{% trans "Клиентов" %}</div>
                </div>
                <div class="segment-stat">
                    <div class="value">{{ stats.total_revenue|floatformat:0 }} ₽</div>
                    <div class="label">{% trans "Выручка" %}</div>
                </div>
            </div>
            {% endwith %}
            {% endif %}
            <div class="customer-list">
                {% for customer_data in customers|slice:":10" %}
                <div class="customer-item">
                    <div>
                        <strong>{{ customer_data.customer.username }}</strong><br>
                        <small>
                            RFM: <span class="rfm-score">{{ customer_data.rfm_score }}</span> |
                            {{ customer_data.days_since_last }} {% trans "дней назад" %} |
                            {{ customer_data.frequency }} {% trans "заказов" %} |
                            {{ customer_data.monetary|floatformat:2 }} ₽
                        </small>
                    </div>
                    <a href="/admin/paint_shop_project/user/{{ customer_data.customer.id }}/change/" class="button">{% trans "Открыть" %}</a>
                </div>
                {% endfor %}
                {% if customers|length > 10 %}
                <p class="help">... и еще {{ customers|length|add:"-10" }} клиентов</p>
                {% endif %}
            </div>
        </div>
        {% endif %}
        {% endfor %}
    </div>
</div>
{% endblock %}

