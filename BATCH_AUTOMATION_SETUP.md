# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å –ø–∞—Ä—Ç–∏—è–º–∏ —Ç–æ–≤–∞—Ä–æ–≤

## ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### 1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –ø–∞—Ä—Ç–∏–π

**–ö–æ–º–∞–Ω–¥–∞**: `python manage.py spoil_expired_batches`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª**:
- –ù–∞—Ö–æ–¥–∏—Ç –≤—Å–µ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –ø–∞—Ä—Ç–∏–∏ —Å –æ—Å—Ç–∞—Ç–∫–æ–º > 0
- –°–ø–∏—Å—ã–≤–∞–µ—Ç –æ—Å—Ç–∞—Ç–∫–∏ (—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `remaining_quantity = 0`)
- –õ–æ–≥–∏—Ä—É–µ—Ç –≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –≤ `BatchAuditLog`
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ + Telegram)

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:
- `--dry-run` - —Ç–æ–ª—å–∫–æ –ø–æ–∫–∞–∑–∞—Ç—å, —á—Ç–æ –±—É–¥–µ—Ç —Å–ø–∏—Å–∞–Ω–æ, –±–µ–∑ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–ø–∏—Å–∞–Ω–∏—è
- `--notify` - –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º
- `--days-overdue N` - —Å–ø–∏—Å—ã–≤–∞—Ç—å –ø–∞—Ä—Ç–∏–∏, –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –Ω–∞ N –¥–Ω–µ–π –∏ –±–æ–ª–µ–µ

**–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è**:
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑ —Å–ø–∏—Å–∞–Ω–∏—è
python manage.py spoil_expired_batches --dry-run

# –°–ø–∏—Å–∞–Ω–∏–µ —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏
python manage.py spoil_expired_batches --notify

# –°–ø–∏—Å–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏–π, –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –Ω–∞ 3+ –¥–Ω—è
python manage.py spoil_expired_batches --days-overdue 3 --notify
```

### 2. –ê—É–¥–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–∞—Ä—Ç–∏–π

**–ú–æ–¥–µ–ª—å**: `BatchAuditLog`

**–ß—Ç–æ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è**:
- –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏–π
- –ò–∑–º–µ–Ω–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–æ–≤
- –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø–∞—Ä—Ç–∏–π –∑–∞–∫–∞–∑–∞–º
- –°–Ω—è—Ç–∏–µ –ø–∞—Ä—Ç–∏–π —Å –∑–∞–∫–∞–∑–æ–≤
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –ø–∞—Ä—Ç–∏–π
- –£–¥–∞–ª–µ–Ω–∏–µ –ø–∞—Ä—Ç–∏–π

**–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤ –ª–æ–≥–∞—Ö**:
- –ü–∞—Ä—Ç–∏—è
- –î–µ–π—Å—Ç–≤–∏–µ
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–∏–ª–∏ "–°–∏—Å—Ç–µ–º–∞" –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π)
- –°—Ç–∞—Ä–æ–µ –∏ –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–∞
- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
- IP-–∞–¥—Ä–µ—Å
- –í—Ä–µ–º—è –¥–µ–π—Å—Ç–≤–∏—è

**–î–æ—Å—Ç—É–ø**: –ê–¥–º–∏–Ω–∫–∞ ‚Üí –õ–æ–≥–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–∞—Ä—Ç–∏–π

### 3. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞**:
1. –°–æ–∑–¥–∞–π—Ç–µ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ [@BotFather](https://t.me/BotFather) –≤ Telegram
2. –ü–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞
3. –î–æ–±–∞–≤—å—Ç–µ –≤ `settings.py`:
   ```python
   TELEGRAM_BOT_TOKEN = '–≤–∞—à_—Ç–æ–∫–µ–Ω_–±–æ—Ç–∞'
   TELEGRAM_ENABLE_NOTIFICATIONS = True
   ```
4. –£–∫–∞–∂–∏—Ç–µ `telegram_chat_id` –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –≤ –∞–¥–º–∏–Ω–∫–µ
5. –í–∫–ª—é—á–∏—Ç–µ `telegram_notifications_enabled` –¥–ª—è –Ω—É–∂–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**–ß—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è**:
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å–ø–∏—Å–∞–Ω–∏–∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –ø–∞—Ä—Ç–∏–π
- –î–µ—Ç–∞–ª–∏ –ø–æ —Ç–æ–≤–∞—Ä–∞–º –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É
- –ü—Ä–∏–º–µ—Ä–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å —Å–ø–∏—Å–∞–Ω–Ω–æ–≥–æ

## üìÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–ø—É—Å–∫–∞

### Linux/Mac (cron)

–î–æ–±–∞–≤—å—Ç–µ –≤ crontab (`crontab -e`):
```bash
# –°–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –ø–∞—Ä—Ç–∏–π –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 2:00 –Ω–æ—á–∏
0 2 * * * cd /path/to/project && /path/to/python manage.py spoil_expired_batches --notify >> /var/log/spoil_batches.log 2>&1
```

### Windows (Task Scheduler)

1. –û—Ç–∫—Ä–æ–π—Ç–µ –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞–Ω–∏–π
2. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ
3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ:
   - **–¢—Ä–∏–≥–≥–µ—Ä**: –ï–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 2:00
   - **–î–µ–π—Å—Ç–≤–∏–µ**: –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≥—Ä–∞–º–º—ã
   - **–ü—Ä–æ–≥—Ä–∞–º–º–∞**: `C:\path\to\python.exe`
   - **–ê—Ä–≥—É–º–µ–Ω—Ç—ã**: `C:\path\to\project\manage.py spoil_expired_batches --notify`
   - **–†–∞–±–æ—á–∞—è –ø–∞–ø–∫–∞**: `C:\path\to\project`

### Docker (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)

–î–æ–±–∞–≤—å—Ç–µ –≤ `docker-compose.yml`:
```yaml
services:
  cron:
    image: your-django-image
    command: >
      sh -c "while true; do
        python manage.py spoil_expired_batches --notify
        sleep 86400
      done"
    volumes:
      - .:/app
```

### Celery (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞)

–°–æ–∑–¥–∞–π—Ç–µ –∑–∞–¥–∞—á—É –≤ `tasks.py`:
```python
from celery import shared_task
from django.core.management import call_command

@shared_task
def spoil_expired_batches_task():
    """–ï–∂–µ–¥–Ω–µ–≤–Ω–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –ø–∞—Ä—Ç–∏–π"""
    call_command('spoil_expired_batches', '--notify')
```

–ò –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫—É—é –∑–∞–¥–∞—á—É –≤ Celery Beat.

## üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ —Å–ø–∏—Å–∞–Ω–∏–π

1. –ê–¥–º–∏–Ω–∫–∞ ‚Üí –õ–æ–≥–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–∞—Ä—Ç–∏–π
2. –§–∏–ª—å—Ç—Ä: `action = "spoiled"`
3. –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–µ—Ç–∞–ª–µ–π –ø–æ –∫–∞–∂–¥–æ–π —Å–ø–∏—Å–∞–Ω–Ω–æ–π –ø–∞—Ä—Ç–∏–∏

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

–í –∞–¥–º–∏–Ω–∫–µ –º–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ø–∏—Å–∞–Ω–Ω—ã—Ö –ø–∞—Ä—Ç–∏–π –∑–∞ –ø–µ—Ä–∏–æ–¥
- –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ø–∏—Å–∞–Ω–Ω—ã—Ö –µ–¥–∏–Ω–∏—Ü
- –ü—Ä–∏–º–µ—Ä–Ω—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å —Å–ø–∏—Å–∞–Ω–Ω–æ–≥–æ

### Prometheus –º–µ—Ç—Ä–∏–∫–∏

–ú–µ—Ç—Ä–∏–∫–∞ `zhevzhik_batches_expired_total` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –ø–∞—Ä—Ç–∏–π.

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ü–µ—Ä–µ–¥ –ø–µ—Ä–≤—ã–º –∑–∞–ø—É—Å–∫–æ–º —Å–¥–µ–ª–∞–π—Ç–µ –±—ç–∫–∞–ø –ë–î
2. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: –°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å `--dry-run` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
3. **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è**: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Telegram –±–æ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
4. **–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞**: –ö–æ–º–∞–Ω–¥–∞ –¥–æ–ª–∂–Ω–∞ –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –ø—Ä–∞–≤–∞–º–∏ –Ω–∞ –∑–∞–ø–∏—Å—å –≤ –ë–î

## üêõ –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –ö–æ–º–∞–Ω–¥–∞ –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –ø–∞—Ä—Ç–∏–∏

- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤ –ë–î –µ—Å—Ç—å –ø–∞—Ä—Ç–∏–∏ —Å `expiry_date < today`
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —É –ø–∞—Ä—Ç–∏–π `remaining_quantity > 0`

### –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è

- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Telegram –±–æ—Ç–∞ –≤ `settings.py`
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ —É–∫–∞–∑–∞–Ω `telegram_chat_id`
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `telegram_notifications_enabled = True`
- –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏ Django –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫

### –û—à–∏–±–∫–∏ –ø—Ä–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–∏

- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –º–∏–≥—Ä–∞—Ü–∏—è `0023_add_batch_audit_log` –ø—Ä–∏–º–µ–Ω–µ–Ω–∞
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –º–æ–¥–µ–ª—å `BatchAuditLog` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –ë–î


