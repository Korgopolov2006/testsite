# üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ—Ç—Ä–∏–∫ Prometheus

## –ü—Ä–æ–±–ª–µ–º–∞: "Empty query result" –¥–ª—è `zhevzhik_users_total`

### ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: –ú–µ—Ç—Ä–∏–∫–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è

–ú–µ—Ç—Ä–∏–∫–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:
```
zhevzhik_users_total 10.0
```

### üîß –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –∏ —Ä–µ—à–µ–Ω–∏—è

#### 1. Prometheus –Ω–µ –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ endpoint

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:**
- –û—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ: `http://127.0.0.1:8000/metrics/`
- –î–æ–ª–∂–Ω–∞ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏
- –ù–∞–π–¥–∏—Ç–µ —Å—Ç—Ä–æ–∫—É: `zhevzhik_users_total 10.0`

**–ï—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ Django —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω: `python manage.py runserver 0.0.0.0:8000`
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `ALLOWED_HOSTS` –≤ `settings.py`

#### 2. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Prometheus

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π–ª `prometheus.yml`:**

```yaml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: 'zhevzhik'
    metrics_path: '/metrics'
    static_configs:
      - targets: ['127.0.0.1:8000']  # –ò–ª–∏ 'localhost:8000'
        labels:
          instance: 'zhevzhik-app'
```

**–í–∞–∂–Ω–æ:**
- –ï—Å–ª–∏ Django –∑–∞–ø—É—â–µ–Ω –Ω–∞ `127.0.0.1:8000`, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `127.0.0.1:8000`
- –ï—Å–ª–∏ Django –∑–∞–ø—É—â–µ–Ω –Ω–∞ `0.0.0.0:8000`, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `127.0.0.1:8000` –∏–ª–∏ `localhost:8000`
- –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ Docker, –≤–æ–∑–º–æ–∂–Ω–æ –Ω—É–∂–µ–Ω `host.docker.internal:8000`

#### 3. Prometheus –Ω–µ –º–æ–∂–µ—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Django

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ Prometheus UI (http://localhost:9090):**

1. –û—Ç–∫—Ä–æ–π—Ç–µ **Status** ‚Üí **Targets**
2. –ù–∞–π–¥–∏—Ç–µ target `zhevzhik`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å:
   - ‚úÖ **UP** - –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç
   - ‚ùå **DOWN** - –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º–∞

**–ï—Å–ª–∏ DOWN:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Prometheus
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ Django —Å–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ firewall/–∞–Ω—Ç–∏–≤–∏—Ä—É—Å

#### 4. –ú–µ—Ç—Ä–∏–∫–∞ –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è

**–†–µ—à–µ–Ω–∏–µ:** –û–±–Ω–æ–≤–∏—Ç–µ –º–µ—Ç—Ä–∏–∫—É –≤—Ä—É—á–Ω—É—é:
```python
python manage.py shell
>>> from paint_shop.metrics import get_custom_metrics
>>> get_custom_metrics()
```

#### 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ Prometheus UI

**–û—Ç–∫—Ä–æ–π—Ç–µ Prometheus (http://localhost:9090):**

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Graph**
2. –í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å: `zhevzhik_users_total`
3. –ù–∞–∂–º–∏—Ç–µ **Execute**

**–ï—Å–ª–∏ –º–µ—Ç—Ä–∏–∫–∞ –Ω–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—Ä–µ–º—è (time range) - –≤–æ–∑–º–æ–∂–Ω–æ –º–µ—Ç—Ä–∏–∫–∞ —Å–ª–∏—à–∫–æ–º —Å—Ç–∞—Ä–∞—è
- –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–ø—Ä–æ—Å: `up{job="zhevzhik"}` - –¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å `1`
- –ï—Å–ª–∏ `up{job="zhevzhik"}` = `0`, –∑–Ω–∞—á–∏—Ç Prometheus –Ω–µ –º–æ–∂–µ—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è

#### 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –º–µ—Ç—Ä–∏–∫

**–û—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ:** `http://127.0.0.1:8000/metrics/`

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:**
- –ï—Å—Ç—å –ª–∏ —Å—Ç—Ä–æ–∫–∞: `# HELP zhevzhik_users_total Total number of users`
- –ï—Å—Ç—å –ª–∏ —Å—Ç—Ä–æ–∫–∞: `# TYPE zhevzhik_users_total gauge`
- –ï—Å—Ç—å –ª–∏ —Å—Ç—Ä–æ–∫–∞: `zhevzhik_users_total 10.0` (–∏–ª–∏ –¥—Ä—É–≥–æ–µ —á–∏—Å–ª–æ)

**–§–æ—Ä–º–∞—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å:**
```
# HELP zhevzhik_users_total Total number of users
# TYPE zhevzhik_users_total gauge
zhevzhik_users_total 10.0
```

#### 7. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Prometheus

**–ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:**
1. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Prometheus
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é: `promtool check config prometheus.yml`
3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–Ω–æ–≤–∞: `prometheus.exe --config.file=prometheus.yml`

---

## ‚úÖ –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ endpoint
```bash
curl http://127.0.0.1:8000/metrics/ | grep zhevzhik_users_total
```

–î–æ–ª–∂–Ω–æ –≤—ã–≤–µ—Å—Ç–∏:
```
# HELP zhevzhik_users_total Total number of users
# TYPE zhevzhik_users_total gauge
zhevzhik_users_total 10.0
```

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ Prometheus
1. –û—Ç–∫—Ä–æ–π—Ç–µ: http://localhost:9090
2. –í–≤–µ–¥–∏—Ç–µ: `up{job="zhevzhik"}`
3. –î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å: `1`

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –º–µ—Ç—Ä–∏–∫—É
1. –í Prometheus –≤–≤–µ–¥–∏—Ç–µ: `zhevzhik_users_total`
2. –î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ

---

## üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ —Å–¥–µ–ª–∞–Ω—ã

1. ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è `status_code` –≤ —Å—Ç—Ä–æ–∫—É –≤ middleware
2. ‚úÖ –£–¥–∞–ª–µ–Ω–∞ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –º–µ—Ç—Ä–∏–∫–∞ `zhevzhik_users_active_5min` –∏–∑ HELP –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
3. ‚úÖ –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –º–µ—Ç—Ä–∏–∫

---

## üìù –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ —Ä–µ—à–µ–Ω–∞

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Django: –Ω–µ—Ç –ª–∏ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –º–µ—Ç—Ä–∏–∫
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Prometheus: –Ω–µ—Ç –ª–∏ –æ—à–∏–±–æ–∫ –ø—Ä–∏ scrape
3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –º–µ—Ç—Ä–∏–∫–∞ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è (–≤—ã–∑–æ–≤–∏—Ç–µ `get_custom_metrics()`)
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤—Ä–µ–º—è –≤ Prometheus —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç–µ–∫—É—â–µ–º—É –≤—Ä–µ–º–µ–Ω–∏

---

## üöÄ –ì–æ—Ç–æ–≤–æ!

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –º–µ—Ç—Ä–∏–∫–∞ –¥–æ–ª–∂–Ω–∞ —Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ. –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –æ—Å—Ç–∞—ë—Ç—Å—è, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Prometheus –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å endpoint'–∞.

