# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ —Å–∏—Å—Ç–µ–º–µ –º–µ—Ç—Ä–∏–∫ Prometheus

## ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –ö–æ–Ω—Ñ–ª–∏–∫—Ç URL –ø—É—Ç–µ–π
**–ü—Ä–æ–±–ª–µ–º–∞**: –î–≤–∞ –ø—É—Ç–∏ –¥–ª—è `/metrics/` –≤ `urls.py`:
- `path('metrics/', include('django_prometheus.urls'))` (—Å—Ç—Ä–æ–∫–∞ 106)
- `path('metrics/', prometheus_metrics_view, name='prometheus_metrics')` (—Å—Ç—Ä–æ–∫–∞ 151)

**–†–µ—à–µ–Ω–∏–µ**: –£–¥–∞–ª—ë–Ω –¥—É–±–ª–∏—Ä—É—é—â–∏–π –ø—É—Ç—å `django_prometheus.urls`, –æ—Å—Ç–∞–≤–ª–µ–Ω —Ç–æ–ª—å–∫–æ –∫–∞—Å—Ç–æ–º–Ω—ã–π `prometheus_metrics_view`.

### 2. –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –º–µ—Ç—Ä–∏–∫
**–ü—Ä–æ–±–ª–µ–º–∞**: Django ORM –Ω–µ –º–æ–∂–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å JSONField –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ `values().annotate()`.

**–†–µ—à–µ–Ω–∏–µ**: –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Ä—É—á–Ω–∞—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –º–µ—Ç—Ä–∏–∫:
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `json.dumps()` –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª—é—á–∞ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏
- –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –º–µ—Ç—Ä–∏–∫ (counter, gauge, histogram)

### 3. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∑–Ω–∞—á–µ–Ω–∏–π
**–ü—Ä–æ–±–ª–µ–º–∞**: Prometheus –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç NaN –∏ Infinity –∑–Ω–∞—á–µ–Ω–∏—è, —á—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –æ—à–∏–±–∫–∞–º –ø–∞—Ä—Å–∏–Ω–≥–∞.

**–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–ª–µ–Ω—ã —Ñ—É–Ω–∫—Ü–∏–∏:
- `_is_valid_number()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å —á–∏—Å–ª–∞
- `_format_metric_value()` - —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –∑–∞–º–µ–Ω–æ–π –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –Ω–∞ 0.0

### 4. –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ –≤ –º–µ—Ç–∫–∞—Ö
**–ü—Ä–æ–±–ª–µ–º–∞**: –ó–Ω–∞—á–µ–Ω–∏—è –º–µ—Ç–æ–∫ –º–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∫–∞–≤—ã—á–∫–∏, –æ–±—Ä–∞—Ç–Ω—ã–µ —Å–ª—ç—à–∏ –∏ –¥—Ä—É–≥–∏–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞—Ç—å.

**–†–µ—à–µ–Ω–∏–µ**: –£–ª—É—á—à–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `format_labels()`:
- –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–≤—ã—á–µ–∫: `"` ‚Üí `\"`
- –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞—Ç–Ω—ã—Ö —Å–ª—ç—à–µ–π: `\` ‚Üí `\\`
- –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ —Å—Ç—Ä–æ–∫: `\n` ‚Üí `\\n`

### 5. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
**–ü—Ä–æ–±–ª–µ–º–∞**: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –º–µ—Ç—Ä–∏–∫ –º–æ–≥–ª–æ –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –ø–∞–¥–µ–Ω–∏—é endpoint'–∞.

**–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–ª–µ–Ω `try/except` –±–ª–æ–∫ –≤ `prometheus_metrics_view()` –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –º–µ—Ç—Ä–∏–∫.

---

## üìä –§–æ—Ä–º–∞—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞ –º–µ—Ç—Ä–∏–∫

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤—ã–≤–æ–¥–∞:
1. **HELP –∏ TYPE –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏** (–¥–ª—è –≤—Å–µ—Ö –º–µ—Ç—Ä–∏–∫)
2. **Counter –º–µ—Ç—Ä–∏–∫–∏** (—Å—É–º–º–∏—Ä—É—é—Ç—Å—è –ø–æ –≥—Ä—É–ø–ø–∞–º name+labels)
3. **Gauge –º–µ—Ç—Ä–∏–∫–∏** (–ø–æ—Å–ª–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø—ã name+labels)
4. **Histogram –º–µ—Ç—Ä–∏–∫–∏** (count, sum, avg –¥–ª—è –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø—ã name+labels)

### –ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:
```
# HELP zhevzhik_users_total Total number of users
# TYPE zhevzhik_users_total gauge
zhevzhik_users_total 150.0
zhevzhik_http_requests_total{method="GET",path="/",status_code="200"} 19.0
zhevzhik_http_request_duration_seconds_avg{method="GET",path="/"} 0.123
```

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–∫–∞–∑–∞–ª–æ:
- ‚úÖ –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—Ç–æ–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è —á–∏—Å–µ–ª –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤—ã–≤–∞–µ—Ç NaN –∏ Infinity
- ‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–µ—Ç—Ä–∏–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç (205+ —Å—Ç—Ä–æ–∫ –º–µ—Ç—Ä–∏–∫)
- ‚úÖ –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç

---

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ—Ç—Ä–∏–∫ –≤ Grafana

### –®–∞–≥–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ endpoint –º–µ—Ç—Ä–∏–∫**:
   ```
   http://127.0.0.1:8000/metrics/
   ```

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç –≤ Prometheus**:
   - –û—Ç–∫—Ä–æ–π—Ç–µ Prometheus: http://localhost:9090
   - –í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å: `zhevzhik_users_total`
   - –ú–µ—Ç—Ä–∏–∫–∞ –¥–æ–ª–∂–Ω–∞ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ Grafana**:
   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Prometheus data source –ø–æ–¥–∫–ª—é—á–µ–Ω
   - –°–æ–∑–¥–∞–π—Ç–µ –ø–∞–Ω–µ–ª—å —Å –∑–∞–ø—Ä–æ—Å–æ–º: `zhevzhik_users_total`
   - –î–∞–Ω–Ω—ã–µ –¥–æ–ª–∂–Ω—ã –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- –í—Å–µ –º–µ—Ç—Ä–∏–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î (–º–æ–¥–µ–ª—å `Metric`)
- –ú–µ—Ç—Ä–∏–∫–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ –∫ `/metrics/`
- –ú–µ—Ç—Ä–∏–∫–∏ –≥—Ä—É–ø–ø–∏—Ä—É—é—Ç—Å—è –ø–æ `name` + `labels` (JSON —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è)
- –ù–µ–≤–∞–ª–∏–¥–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (NaN, Infinity) –∑–∞–º–µ–Ω—è—é—Ç—Å—è –Ω–∞ 0.0

---

## üöÄ –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

–°–∏—Å—Ç–µ–º–∞ –º–µ—Ç—Ä–∏–∫ —Ç–µ–ø–µ—Ä—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ Prometheus –∏ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –≤ Grafana!

