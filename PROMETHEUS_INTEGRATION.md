# üîß –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –º–µ—Ç—Ä–∏–∫ —Å Prometheus

## ‚úÖ –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. –°–æ–∑–¥–∞–Ω–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –Ω–∞—Ç–∏–≤–Ω—ã–º–∏ Prometheus –º–µ—Ç—Ä–∏–∫–∞–º–∏

**–§–∞–π–ª:** `paint_shop_project/prometheus_metrics.py`

- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫—É `prometheus_client` –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –º–µ—Ç—Ä–∏–∫
- –í—Å–µ –º–µ—Ç—Ä–∏–∫–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–º `REGISTRY`
- –°–æ–≤–º–µ—Å—Ç–∏–º–æ —Å `django_prometheus`

### 2. –û–±–Ω–æ–≤–ª—ë–Ω endpoint –º–µ—Ç—Ä–∏–∫

**–§–∞–π–ª:** `paint_shop_project/metrics_views.py`

- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `generate_latest(REGISTRY)` –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤—Å–µ—Ö –º–µ—Ç—Ä–∏–∫
- –í–∫–ª—é—á–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ `django_prometheus` –∏ –Ω–∞—à–∏ –∫–∞—Å—Ç–æ–º–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –±–∏–∑–Ω–µ—Å-–º–µ—Ç—Ä–∏–∫–∏ –ø–µ—Ä–µ–¥ —ç–∫—Å–ø–æ—Ä—Ç–æ–º

### 3. –û–±–Ω–æ–≤–ª—ë–Ω middleware

**–§–∞–π–ª:** `paint_shop_project/prometheus_middleware.py`

- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–∞—Ç–∏–≤–Ω—ã–µ Prometheus –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
- Fallback –Ω–∞ —Å—Ç–∞—Ä—É—é —Å–∏—Å—Ç–µ–º—É, –µ—Å–ª–∏ `prometheus_client` –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω

---

## üöÄ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:

```
HTTP Request
    ‚Üì
PrometheusMetricsMiddleware (—Å–æ–±–∏—Ä–∞–µ—Ç HTTP –º–µ—Ç—Ä–∏–∫–∏)
    ‚Üì
Django View
    ‚Üì
/metrics/ endpoint
    ‚Üì
update_business_metrics() (–æ–±–Ω–æ–≤–ª—è–µ—Ç –±–∏–∑–Ω–µ—Å-–º–µ—Ç—Ä–∏–∫–∏ –∏–∑ –ë–î)
    ‚Üì
generate_latest(REGISTRY) (—ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –í–°–ï –º–µ—Ç—Ä–∏–∫–∏)
    ‚Üì
Prometheus —Å–æ–±–∏—Ä–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏
```

### –¢–∏–ø—ã –º–µ—Ç—Ä–∏–∫:

1. **HTTP –º–µ—Ç—Ä–∏–∫–∏** (—Å–æ–±–∏—Ä–∞—é—Ç—Å—è middleware):
   - `zhevzhik_http_requests_total` - Counter
   - `zhevzhik_http_request_duration_seconds` - Histogram
   - `zhevzhik_http_errors_total` - Counter
   - `zhevzhik_http_exceptions_total` - Counter

2. **–ë–∏–∑–Ω–µ—Å-–º–µ—Ç—Ä–∏–∫–∏** (–æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∏–∑ –ë–î):
   - `zhevzhik_users_total` - Gauge
   - `zhevzhik_users_active` - Gauge
   - `zhevzhik_users_today` - Gauge
   - `zhevzhik_orders_total` - Gauge
   - `zhevzhik_orders_today` - Gauge
   - `zhevzhik_orders_by_status` - Gauge (—Å –º–µ—Ç–∫–æ–π `status`)
   - `zhevzhik_revenue_total` - Gauge
   - `zhevzhik_revenue_today` - Gauge
   - `zhevzhik_avg_order_value` - Gauge
   - –ò –¥—Ä—É–≥–∏–µ...

3. **–ú–µ—Ç—Ä–∏–∫–∏ django_prometheus** (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏):
   - `django_http_requests_total`
   - `django_http_responses_total`
   - –ò –¥—Ä—É–≥–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏

---

## üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

### 1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ endpoint:

```bash
curl http://127.0.0.1:8000/metrics/ | grep zhevzhik_users_total
```

–î–æ–ª–∂–Ω–æ –≤—ã–≤–µ—Å—Ç–∏:
```
# HELP zhevzhik_users_total Total number of users
# TYPE zhevzhik_users_total gauge
zhevzhik_users_total 10.0
```

### 2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ Prometheus:

1. –û—Ç–∫—Ä–æ–π—Ç–µ Prometheus: http://localhost:9090
2. –í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å: `zhevzhik_users_total`
3. –î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ

### 3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—Å–µ –º–µ—Ç—Ä–∏–∫–∏:

–í Prometheus –≤–≤–µ–¥–∏—Ç–µ: `{__name__=~"zhevzhik_.*"}`

–î–æ–ª–∂–Ω—ã –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å—Å—è –≤—Å–µ –≤–∞—à–∏ –∫–∞—Å—Ç–æ–º–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏.

---

## üîß –ï—Å–ª–∏ –º–µ—Ç—Ä–∏–∫–∏ –Ω–µ –≤–∏–¥–Ω—ã

### –ü—Ä–æ–±–ª–µ–º–∞ 1: prometheus_client –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω

**–†–µ—à–µ–Ω–∏–µ:**
```bash
pip install prometheus-client
```

### –ü—Ä–æ–±–ª–µ–º–∞ 2: –ú–µ—Ç—Ä–∏–∫–∏ –Ω–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è

**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `update_business_metrics()`:
- –û—Ç–∫—Ä–æ–π—Ç–µ `/metrics/` –≤ –±—Ä–∞—É–∑–µ—Ä–µ
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫ –∞–∫—Ç—É–∞–ª—å–Ω—ã

### –ü—Ä–æ–±–ª–µ–º–∞ 3: Prometheus –Ω–µ –º–æ–∂–µ—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è

**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:
- Django —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω: `python manage.py runserver 0.0.0.0:8000`
- Endpoint –¥–æ—Å—Ç—É–ø–µ–Ω: `http://127.0.0.1:8000/metrics/`
- Prometheus –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è

### –ü—Ä–æ–±–ª–µ–º–∞ 4: Fallback –Ω–∞ —Å—Ç–∞—Ä—É—é —Å–∏—Å—Ç–µ–º—É

–ï—Å–ª–∏ `prometheus_client` –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è fallback –Ω–∞ —Å—Ç–∞—Ä—É—é —Å–∏—Å—Ç–µ–º—É —á–µ—Ä–µ–∑ –ë–î.

**–†–µ—à–µ–Ω–∏–µ:** –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ `prometheus-client`:
```bash
pip install prometheus-client
```

---

## ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã

1. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –ú–µ—Ç—Ä–∏–∫–∏ –≤ –ø–∞–º—è—Ç–∏, –Ω–µ –Ω—É–∂–Ω–æ –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ –ë–î –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ
2. **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**: –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ —Å `django_prometheus`
3. **–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ—Å—Ç—å**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É `prometheus_client`
4. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ**: –ú–µ—Ç—Ä–∏–∫–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ `/metrics/`

---

## üéØ –ì–æ—Ç–æ–≤–æ!

–ú–µ—Ç—Ä–∏–∫–∏ —Ç–µ–ø–µ—Ä—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã —Å Prometheus –∏ –¥–æ–ª–∂–Ω—ã –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!

–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –æ—Å—Ç–∞—ë—Ç—Å—è, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:
1. –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–∏ `prometheus-client`: `pip install prometheus-client`
2. –î–æ—Å—Ç—É–ø–µ–Ω –ª–∏ endpoint: `http://127.0.0.1:8000/metrics/`
3. –ü—Ä–∞–≤–∏–ª—å–Ω–æ –ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω Prometheus

